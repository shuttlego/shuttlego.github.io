# 출발시간 범위(물결) 저장 및 표시 설계

## 목표

xlsx에서 "06:20 ~ 07:35"처럼 **물결로 된 출발시간**은 10분 단위로 쪼개지 않고, **범위 그대로** 저장해 사용자에게 "06:20 ~ 07:35" 형태로 보여준다.

---

## 1. departure_times.csv 형태

### 권장: 기존 2컬럼 유지, `time`에 문자열 그대로 저장 (안 A)

| 컬럼 | 설명 |
|------|------|
| route_id | 기존과 동일 |
| time | 단일: `"06:30"` / 범위: `"06:20 ~ 07:35"` |

- **단일 시각**: 지금처럼 `"HH:MM"` 한 개.
- **범위**: `"HH:MM ~ HH:MM"` 한 문자열로 한 행만 저장 (공백·물결표는 정규화해서 통일).

**장점**

- CSV 스키마 변경 없음 (기존 `route_id`, `time` 유지).
- 표시 문자열 = 저장 값이라 프론트는 그대로 `time`만 이스케이프해서 보여주면 됨.
- xlsx_to_csv만 수정하면 됨 (범위일 때 한 행으로 `"06:20 ~ 07:35"` 넣기).

**단점**

- "가장 가까운 출발시간" 계산 시 범위 파싱 필요 (아래 3절).

---

### 대안: time_start / time_end 추가 (안 B)

| route_id | time_start | time_end |
|----------|------------|----------|
| 1 | 06:30 | |
| 2 | 06:20 | 07:35 |

- 단일: `time_end` 비움 또는 `time_start`와 동일.
- 범위: `time_start`, `time_end` 모두 채움.

**장점**: 정렬·비교 로직이 명확.  
**단점**: CSV·로드·API 응답 구조 변경 필요.

---

## 2. xlsx_to_csv.py 변경

- **현재**: 범위 "06:20 ~ 07:35"를 10분 간격으로 쪼개어 여러 행으로 저장.
- **변경**:
  - `parse_time_cell()`: 범위면 **한 개의 문자열** `"06:20 ~ 07:35"` 반환 (리스트 길이 1).
  - 단일 시각은 기존처럼 `["06:30"]`.
  - 물결/공백은 정규화 (예: `~` 앞뒤 공백 하나, `\n` 제거)해서 형식 통일.
- `RANGE_INTERVAL_MINUTES` 환경변수는 **제거**하거나 무시 (범위는 항상 한 행).

---

## 3. load_data.py 변경

현재 `departure_times`는 `route_id → [ "06:30", "07:00", ... ]` 형태이고,  
`_time_to_minutes("06:30")`으로 분 단위 변환 후 정렬·비교한다.

### 3.1 범위 파싱 헬퍼

- `_parse_time_or_range(t: str) -> tuple[int, int]`
  - 단일 "HH:MM" → `(분, 분)` (동일 값 두 개).
  - "HH:MM ~ HH:MM" → `(시작분, 종료분)`.
  - 파싱 실패 시 `(-1, -1)` 등으로 실패 표현.

### 3.2 정렬 (get_all_departure_times)

- 정렬 키: 위 헬퍼로 `(start_min, end_min)` 구한 뒤 **시작 시각(start_min)** 기준 정렬.
- 단일/범위 섞여 있어도 시작 시각 순으로 나열 가능.

### 3.3 get_nearest_departure_time

- 사용자 시각 `time_str` → `user_m` (분).
- 각 `t`에 대해:
  - `(start_m, end_m) = _parse_time_or_range(t)`
  - **범위인 경우**: `start_m <= user_m <= end_m` 이면 "이 구간 안에 있음" → `t`(예: "06:20 ~ 07:35") 반환.
  - **단일/범위 공통**: `user_m <= start_m` 이면 "아직 안 출발한 다음 배차" 후보.
- 후보들을 시작 시각 순 정렬한 뒤,  
  - (1) 사용자 시각이 포함된 범위가 있으면 그 항목 반환,  
  - (2) 없으면 `start_m >= user_m`인 첫 항목 반환,  
  - (3) 없으면 다음날 첫 배차로 맨 첫 항목 반환.

이렇게 하면 "가장 가까운 출발"이 단일 시각이면 기존과 같고, 범위면 "지금 탑승 가능한 구간" 또는 "다음 구간"을 문자열 그대로 반환할 수 있다.

---

## 4. 프론트엔드(HTML/JS)

- `all_departure_times`는 이미 각 항목을 그대로 `<span class="time-item">` 안에 넣어 표시하고 있음.
- `time`이 `"06:20 ~ 07:35"`로 오면 그대로 표시하면 됨 → **추가 수정 없음**.
- `board_time`이 범위 문자열로 올 수 있으므로, "00:00분 탑승" 대신 "06:20 ~ 07:35 탑승"처럼 표시해 주는 편이 자연스러움 (이미 문자열 하나로 표시하므로 그대로 두어도 동작 가능).

---

## 5. 요약

| 구분 | 내용 |
|------|------|
| **CSV** | 안 A: `route_id`, `time` 유지. 범위는 `"06:20 ~ 07:35"` 한 행으로 저장. |
| **xlsx_to_csv** | 범위일 때 한 문자열로 한 행만 출력. `RANGE_INTERVAL_MINUTES` 제거/무시. |
| **load_data** | `_parse_time_or_range`, 정렬 시 시작 시각 사용, `get_nearest_departure_time`에서 범위 포함 여부·다음 배차 후보 처리. |
| **프론트** | 변경 없음 (time 문자열 그대로 표시). |

이렇게 하면 물결 표시는 "임의 10분 단위"가 아니라 원본 범위가 그대로 저장·표시되고, "가장 가까운 출발"도 범위를 고려해 동작한다.
