<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>셔틀 검색</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
    body {
      display: flex;
      flex-direction: column;
      background: #f5f5f5;
    }
    .header {
      flex-shrink: 0;
      padding: 12px 16px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .header-left {
      flex-shrink: 1;
      min-width: 0;
      display: flex;
      align-items: center;
    }
    /* 출발시간/요일 통합 트리거 */
    .departure-trigger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0 12px;
      height: 42px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      user-select: none;
      font-family: inherit;
      white-space: nowrap;
      overflow: hidden;
      min-width: 0;
    }
    .departure-trigger:hover {
      border-color: #fee500;
      background: #fffde7;
    }
    .departure-trigger .trigger-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .departure-trigger .trigger-arrow {
      flex-shrink: 0;
      margin-left: auto;
      width: 0; height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid #666;
    }

    /* 출발 시간 선택 모달 */
    .time-picker-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 100;
    }
    .time-picker-backdrop.show { display: block; }
    .time-picker-modal {
      display: none;
      position: fixed;
      left: 16px;
      right: 16px;
      max-width: 320px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      z-index: 101;
      padding: 16px;
      transition: transform .25s ease, opacity .25s ease;
    }
    .time-picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .time-picker-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .time-picker-modal .time-picker-title {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin: 0;
    }
    .time-picker-wheels {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .time-picker-column {
      flex: 1;
      max-width: 72px;
      height: 160px;
      overflow: hidden;
      position: relative;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    .time-picker-column .time-picker-selection-band {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      margin-top: -20px;
      height: 40px;
      background: rgba(254, 229, 0, 0.22);
      border-radius: 6px;
      pointer-events: none;
      z-index: 0;
    }
    .time-picker-column .time-picker-items {
      position: relative;
      z-index: 1;
      overflow-y: auto;
      height: 100%;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .time-picker-column .time-picker-item {
      height: 40px;
      line-height: 40px;
      text-align: center;
      font-size: 18px;
      font-weight: 500;
      color: #999;
      scroll-snap-align: center;
      scroll-snap-stop: always;
    }
    .time-picker-column .time-picker-item.selected {
      color: #1a1a1a;
      font-weight: 700;
    }
    .time-picker-column .time-picker-pad {
      height: 60px;
      flex-shrink: 0;
      pointer-events: none;
    }
    .time-picker-now,
    .time-picker-five {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      min-width: 72px;
      height: 30px;
      padding: 5px 10px;
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      line-height: 1;
      color: #555;
      cursor: pointer;
      font-family: inherit;
    }
    .time-picker-now:hover,
    .time-picker-five:hover { background: #eee; border-color: #ccc; color: #333; }
    .time-picker-confirm {
      width: 100%;
      padding: 12px;
      background: #fee500;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .time-picker-confirm:hover { background: #f5d800; }
    .time-picker-modal.show { display: block; }

    /* PC: 모달을 출발 시계 바로 아래에, 더 넓게 */
    @media (min-width: 769px) {
      .time-picker-modal {
        left: auto;
        right: auto;
        margin-left: 0;
        min-width: 420px;
        max-width: 480px;
        padding: 20px 24px;
      }
      .time-picker-modal .time-picker-wheels { gap: 16px; margin-bottom: 20px; }
      .time-picker-modal .time-picker-column {
        max-width: 96px;
      }
      .time-picker-modal .time-picker-column .time-picker-item { font-size: 20px; }
      .time-picker-modal .day-type-column {
        width: 150px;
        max-width: none !important;
      }
      .time-picker-modal .day-type-column .time-picker-item { font-size: 15px !important; }
    }
    /* 모바일: 하단 시트 형태, 스크롤 관성 있게 빠르게 */
    @media (max-width: 768px) {
      .time-picker-modal {
        left: 0;
        right: 0;
        max-width: none;
        bottom: 0;
        top: auto;
        border-radius: 16px 16px 0 0;
        padding: 20px 16px calc(env(safe-area-inset-bottom) + 16px);
        max-height: 50vh;
      }
      .time-picker-column .time-picker-items {
        scroll-snap-type: y proximity;
        scroll-snap-stop: normal;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: auto;
        overflow-y: scroll;
        touch-action: pan-y;
      }
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }
    .search-bar {
      display: flex;
      max-width: 560px;
      width: 100%;
      gap: 8px;
    }
    .search-bar input {
      flex: 1;
      min-width: 0;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
    }
    .search-bar input:focus {
      border-color: #fee500;
      box-shadow: 0 0 0 2px rgba(254,229,0,.25);
    }
    .search-bar button {
      padding: 12px 20px;
      background: #fee500;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .search-bar button:hover { background: #f5d800; }
    .search-bar .issue-open-btn {
      min-width: 44px;
      width: 44px;
      padding: 0;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #333;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }
    .search-bar .issue-open-btn:hover {
      border-color: #fee500;
      background: #fffde7;
    }

    /* 노선 선택 화면 전용 헤더 */
    .route-mode-header {
      display: none;
      width: 100%;
      max-width: 642px;
      min-width: 0;
      margin: 0 auto;
      grid-template-columns: minmax(0, 600px) auto;
      column-gap: 12px;
      row-gap: 0;
      align-items: center;
    }
    .header.route-mode {
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .header.route-mode .header-center {
      display: none;
    }
    .header.route-mode .route-mode-header {
      display: grid;
      order: 1;
      flex: 1 0 100%;
      width: 100%;
      max-width: 642px;
      margin: 0 auto;
    }
    .header.route-mode .header-left {
      order: 2;
      flex: 1 1 0;
      min-width: 0;
    }
    .header.route-mode .site-selector-wrap {
      order: 2;
      display: block;
      margin-left: auto;
    }
    .route-mode-topline {
      display: contents;
    }
    .route-mode-left {
      grid-column: 1;
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .route-mode-row-label {
      flex-shrink: 0;
      width: 32px;
      color: #666;
      font-size: 13px;
      font-weight: 700;
      line-height: 1;
      text-align: left;
    }
    .route-mode-actions {
      grid-column: 2;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      gap: 0;
    }
    .route-mode-back-btn {
      height: 42px;
      min-width: 48px;
      padding: 0 10px;
      border: 1px solid #d8d8d8;
      border-radius: 8px;
      background: #efefef;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      font-family: inherit;
    }
    .route-mode-back-btn:hover {
      background: #e5e5e5;
      border-color: #cfcfcf;
    }
    .route-mode-issue-btn {
      height: 42px;
      min-width: 44px;
      width: 44px;
      padding: 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      color: #333;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.2px;
      cursor: pointer;
      font-family: inherit;
    }
    .route-mode-issue-btn:hover {
      border-color: #fee500;
      background: #fffde7;
    }
    .header.route-mode .route-mode-issue-btn {
      display: none;
    }
    .route-mode-secondline {
      grid-column: 1;
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .route-mode-place-label {
      display: flex;
      align-items: center;
      flex: 1 1 auto;
      min-width: 0;
      min-height: 42px;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      font-weight: 600;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .route-endpoint-trigger {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex: 1 1 auto;
      min-width: 0;
      min-height: 42px;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      color: #333;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
    }
    .route-endpoint-trigger:hover {
      border-color: #fee500;
      background: #fffde7;
    }
    .route-endpoint-trigger:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      border-color: #e0e0e0;
      background: #f8f8f8;
    }
    .route-endpoint-trigger .endpoint-trigger-text {
      flex: 1;
      min-width: 0;
      overflow: visible;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.3;
    }
    .route-endpoint-trigger .endpoint-trigger-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid #666;
      flex-shrink: 0;
    }
    .route-mode-hidden {
      display: none !important;
    }

    @media (min-width: 769px) {
      .header.route-mode {
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        grid-template-rows: auto;
        align-items: start;
        justify-content: stretch;
        column-gap: 16px;
      }
      .header.route-mode .route-mode-header {
        grid-column: 2;
        grid-row: 1;
        width: 100%;
        max-width: 642px;
        justify-self: center;
        margin: 0;
      }
      .header.route-mode .header-left {
        grid-column: 1;
        grid-row: 1;
        justify-self: start;
        align-self: start;
        flex: 0 0 auto;
        width: auto;
      }
      .header.route-mode .site-selector-wrap {
        grid-column: 3;
        grid-row: 1;
        justify-self: end;
        align-self: start;
        margin-left: 0;
      }
    }

    /* 사업장 선택 (오른쪽 위, 모달 트리거) */
    .site-selector-wrap {
      flex-shrink: 0;
      position: relative;
    }
    .site-selector-wrap select {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
    .site-selector-trigger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0 12px;
      height: 42px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      white-space: nowrap;
      overflow: hidden;
      max-width: 200px;
    }
    .site-selector-trigger:hover {
      border-color: #fee500;
    }
    .site-selector-trigger:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      border-color: #e0e0e0;
    }
    .site-selector-trigger .site-trigger-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
      flex: 1;
    }
    .site-selector-trigger .site-trigger-arrow {
      flex-shrink: 0;
      width: 0; height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid #666;
    }

    /* 사업장 선택 모달 */
    .site-picker-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 100;
    }
    .site-picker-backdrop.show { display: block; }
    .site-picker-modal {
      display: none;
      position: fixed;
      left: 16px;
      right: 16px;
      max-width: 320px;
      max-height: 70vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      z-index: 101;
      padding: 0;
      flex-direction: column;
      overflow: hidden;
    }
    .site-picker-modal.show { display: flex; }
    .site-picker-modal .site-picker-title {
      flex-shrink: 0;
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin: 0;
      padding: 16px 16px 12px;
      border-bottom: 1px solid #eee;
    }
    .site-picker-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 8px 0;
    }
    .site-picker-item {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: transparent;
      font-size: 15px;
      color: #333;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
    }
    .site-picker-item:hover {
      background: #fffde7;
    }
    .site-picker-item.selected {
      background: #fff9c4;
      font-weight: 600;
      color: #1a1a1a;
    }
    @media (min-width: 769px) {
      .site-picker-modal {
        left: auto;
        right: auto;
        min-width: 280px;
        max-width: 360px;
      }
    }
    @media (max-width: 768px) {
      .site-picker-modal {
        left: 0;
        right: 0;
        max-width: none;
        bottom: 0;
        top: auto;
        max-height: 50vh;
        border-radius: 16px 16px 0 0;
      }
      .site-picker-modal .site-picker-title {
        padding: 20px 16px 12px;
      }
    }

    /* 노선 endpoint 선택 모달 */
    .endpoint-picker-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 108;
    }
    .endpoint-picker-backdrop.show { display: block; }
    .endpoint-picker-modal {
      display: none;
      position: fixed;
      left: 16px;
      right: 16px;
      max-width: 360px;
      max-height: 70vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      z-index: 109;
      padding: 0;
      flex-direction: column;
      overflow: hidden;
    }
    .endpoint-picker-modal.show { display: flex; }
    .endpoint-picker-title-row {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 0;
      padding: 16px 16px 12px;
      border-bottom: 1px solid #eee;
    }
    .endpoint-picker-title {
      font-weight: 700;
      font-size: 16px;
      color: #222;
      margin: 0;
      padding: 0;
    }
    .endpoint-picker-confirm-btn {
      flex-shrink: 0;
      height: 30px;
      padding: 0 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }
    .endpoint-picker-confirm-btn:hover {
      border-color: #fee500;
      background: #fffde7;
    }
    .endpoint-picker-search-wrap {
      flex-shrink: 0;
      padding: 10px 16px;
      border-bottom: 1px solid #f2f2f2;
      background: #fff;
    }
    .endpoint-picker-search-input {
      width: 100%;
      box-sizing: border-box;
      height: 34px;
      padding: 0 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      color: #333;
      font-family: inherit;
      outline: none;
    }
    .endpoint-picker-search-input:focus {
      border-color: #fee500;
      box-shadow: 0 0 0 2px rgba(254, 229, 0, 0.2);
    }
    .endpoint-picker-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0;
    }
    .endpoint-picker-list-header {
      position: sticky;
      top: 0;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px 6px;
      background: #fff;
      border-bottom: 1px solid #f2f2f2;
    }
    .endpoint-picker-all-toggle {
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      padding: 6px 10px;
      cursor: pointer;
      font-family: inherit;
    }
    .endpoint-picker-all-toggle:hover {
      border-color: #fee500;
      background: #fffde7;
    }
    .endpoint-picker-all-toggle.selected {
      border-color: #e0c500;
      background: #fff9c4;
      color: #1a1a1a;
    }
    .endpoint-picker-list-count-label {
      flex-shrink: 0;
      min-width: 42px;
      text-align: right;
      font-size: 11px;
      font-weight: 700;
      color: #777;
    }
    .endpoint-picker-item {
      width: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      border: none;
      background: transparent;
      color: #333;
      text-align: left;
      padding: 12px 16px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
    .endpoint-picker-item .endpoint-item-main {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .endpoint-picker-item .endpoint-item-check {
      width: 14px;
      text-align: center;
      color: #2e7d32;
      font-size: 12px;
      font-weight: 800;
      visibility: hidden;
      flex-shrink: 0;
    }
    .endpoint-picker-item.selected .endpoint-item-check {
      visibility: visible;
    }
    .endpoint-picker-item:hover {
      background: #fffde7;
    }
    .endpoint-picker-item.selected {
      background: #fff9c4;
      color: #1a1a1a;
    }
    .endpoint-picker-item .endpoint-item-label {
      flex: 1;
      min-width: 0;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      white-space: normal;
      word-break: break-word;
      line-height: 1.35;
    }
    .endpoint-picker-item .endpoint-item-label .endpoint-label-line {
      display: block;
      white-space: normal;
      word-break: break-word;
      line-height: 1.35;
    }
    .endpoint-picker-item .endpoint-item-label .endpoint-label-line-primary {
      font-weight: 700;
    }
    .endpoint-picker-item .endpoint-item-label .endpoint-label-line-sub {
      font-weight: 400;
    }
    .endpoint-picker-item .endpoint-item-label .endpoint-label-line-sub.first-sub {
      margin-top: 0.16em;
    }
    .endpoint-picker-item .endpoint-item-label .endpoint-keyword-highlight {
      background: #ffe082;
      color: #111;
      padding: 0 1px;
      border-radius: 2px;
    }
    .endpoint-picker-item .endpoint-item-meta {
      flex-shrink: 0;
      color: #666;
      font-size: 12px;
      font-weight: 600;
    }
    .endpoint-picker-item.selected .endpoint-item-meta {
      color: #333;
    }
    .endpoint-picker-empty {
      padding: 18px 16px;
      font-size: 13px;
      color: #888;
      text-align: center;
    }
    @media (min-width: 769px) {
      .endpoint-picker-modal {
        left: auto;
        right: auto;
        min-width: 320px;
      }
    }
    @media (max-width: 768px) {
      .endpoint-picker-modal {
        left: 0;
        right: 0;
        max-width: none;
        bottom: 0;
        top: auto;
        max-height: 56vh;
        border-radius: 16px 16px 0 0;
      }
      .endpoint-picker-title-row {
        padding: 20px 16px 12px;
      }
    }

    /* 요일 선택 스크롤 휠 */
    .day-type-column {
      flex: none !important;
      max-width: none !important;
      width: 140px;
    }
    .day-type-column .time-picker-item {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 56px !important;
      font-size: 14px !important;
      line-height: 1.2 !important;
      padding: 2px 8px;
      box-sizing: border-box;
    }
    .day-type-column .day-type-label {
      font-weight: 700;
      font-size: 13px;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .day-type-column .day-type-desc {
      font-weight: 400;
      font-size: 10px;
      color: #aaa;
      margin-top: 1px;
      white-space: normal;
      word-break: keep-all;
      text-align: center;
      line-height: 1.3;
      max-width: 100%;
    }
    .day-type-column .time-picker-item.selected .day-type-desc {
      color: #666;
    }
    .day-type-column .time-picker-selection-band {
      margin-top: -28px !important;
      height: 56px !important;
    }
    .day-type-column .time-picker-pad {
      height: 52px !important;
    }

    /* 위치 권한 안내 모달 */
    .location-permission-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 100;
    }
    .location-permission-backdrop.show { display: block; }
    .location-permission-modal {
      display: none;
      position: fixed;
      left: 16px;
      right: 16px;
      max-width: 320px;
      margin: 0 auto;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
      z-index: 101;
      padding: 20px;
    }
    .location-permission-modal.show { display: block; }
    .location-permission-modal .location-permission-message {
      margin: 0 0 20px;
      font-size: 15px;
      line-height: 1.5;
      color: #333;
    }
    .location-permission-modal .location-permission-confirm {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      background: #1976d2;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .location-permission-modal .location-permission-confirm:hover {
      background: #1565c0;
    }

    /* 이슈/건의 모달 */
    .issue-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 110;
    }
    .issue-modal-backdrop.show { display: block; }
    .issue-modal {
      display: none;
      position: fixed;
      left: 50%;
      top: 72px;
      transform: translateX(-50%);
      width: min(720px, calc(100vw - 32px));
      max-height: 82vh;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 36px rgba(0,0,0,.2);
      z-index: 111;
      overflow: hidden;
      flex-direction: column;
    }
    .issue-modal.show { display: flex; }
    .issue-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }
    .issue-modal-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #222;
    }
    .issue-modal-header-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .issue-compose-btn {
      border: 1px solid #fee500;
      background: #fffde7;
      color: #4b3f00;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
    }
    .issue-compose-btn:hover {
      background: #fff9c4;
    }
    .issue-close-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e2e2e2;
      border-radius: 8px;
      background: #fff;
      color: #444;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
    }
    .issue-close-btn:hover {
      background: #f7f7f7;
    }
    .issue-modal-body {
      padding: 14px 16px 16px;
      overflow-y: auto;
      min-height: 0;
      flex: 1;
    }
    .issue-view {
      display: none;
    }
    .issue-view.show {
      display: block;
    }
    .issue-feedback {
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      border: 1px solid transparent;
      display: none;
    }
    .issue-feedback.show {
      display: block;
    }
    .issue-feedback.info {
      background: #f5f5f5;
      border-color: #e0e0e0;
      color: #555;
    }
    .issue-feedback.success {
      background: #e8f5e9;
      border-color: #c8e6c9;
      color: #2e7d32;
    }
    .issue-feedback.error {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #c62828;
    }
    .issue-list-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 10px;
      gap: 8px;
    }
    .issue-support-email {
      display: block;
      margin-top: 10px;
      text-align: center;
      font-size: 12px;
      color: #9a9a9a;
    }
    .issue-state-filter {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 13px;
      background: #fff;
      font-family: inherit;
    }
    .issue-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .issue-empty {
      border: 1px dashed #ddd;
      border-radius: 10px;
      padding: 24px 14px;
      color: #888;
      text-align: center;
      font-size: 14px;
    }
    .issue-card {
      border: 1px solid #ebebeb;
      border-radius: 10px;
      padding: 12px;
      background: #fff;
    }
    .issue-card-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #777;
    }
    .issue-status-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .2px;
    }
    .issue-status-badge.open {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .issue-status-badge.closed {
      background: #eceff1;
      color: #455a64;
    }
    .issue-status-badge.notice {
      background: #fff3bf;
      color: #8a6d00;
    }
    .issue-card-number {
      color: #666;
      font-weight: 600;
      margin-left: 6px;
    }
    .issue-card-title {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 700;
      color: #222;
      line-height: 1.35;
      word-break: break-word;
    }
    .issue-card-body {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .issue-card-footer {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }
    .issue-detail-btn,
    .issue-external-link {
      border: none;
      background: transparent;
      color: #1976d2;
      cursor: pointer;
      padding: 0;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      text-decoration: none;
    }
    .issue-detail-btn:hover,
    .issue-external-link:hover {
      text-decoration: underline;
    }
    .issue-pagination {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .issue-page-btn {
      min-width: 66px;
      padding: 7px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
    }
    .issue-page-btn:disabled {
      opacity: .4;
      cursor: not-allowed;
    }
    .issue-page-info {
      min-width: 72px;
      text-align: center;
      font-size: 13px;
      color: #555;
    }
    .issue-back-btn {
      border: none;
      background: transparent;
      color: #1976d2;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      margin-bottom: 10px;
      font-family: inherit;
    }
    .issue-detail-title {
      margin: 0 0 8px;
      font-size: 17px;
      font-weight: 700;
      color: #222;
      line-height: 1.4;
      word-break: break-word;
    }
    .issue-detail-body {
      padding: 12px;
      border: 1px solid #ececec;
      border-radius: 10px;
      background: #fcfcfc;
      font-size: 13px;
      line-height: 1.55;
      color: #444;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .issue-comments-title {
      margin: 14px 0 8px;
      font-size: 13px;
      color: #555;
      font-weight: 700;
    }
    .issue-comments-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .issue-comment-compose {
      margin-top: 12px;
      border: 1px solid #ececec;
      border-radius: 10px;
      background: #fafafa;
      padding: 10px;
    }
    .issue-comment-compose-title {
      font-size: 13px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }
    .issue-comment-compose textarea {
      width: 100%;
      min-height: 92px;
      resize: vertical;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.5;
      font-family: inherit;
      box-sizing: border-box;
      background: #fff;
    }
    .issue-comment-compose-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
    .issue-comment-item {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    .issue-comment-meta {
      font-size: 12px;
      color: #777;
      margin-bottom: 6px;
    }
    .issue-comment-body {
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      color: #444;
      word-break: break-word;
    }
    .issue-form-group {
      margin-bottom: 12px;
    }
    .issue-form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 700;
      color: #333;
    }
    .issue-form-group input,
    .issue-form-group textarea {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .issue-form-group textarea {
      min-height: 140px;
      resize: vertical;
      line-height: 1.5;
    }
    .issue-form-help {
      margin-top: 4px;
      font-size: 12px;
      color: #777;
      line-height: 1.4;
    }
    .issue-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
    }
    .issue-form-btn {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      color: #333;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .issue-form-btn.primary {
      background: #fee500;
      border-color: #fee500;
      color: #2d2d2d;
    }
    .issue-form-btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }
    @media (max-width: 768px) {
      .issue-modal {
        left: 0;
        right: 0;
        width: 100%;
        top: auto;
        bottom: 0;
        transform: none;
        max-height: 82vh;
        border-radius: 16px 16px 0 0;
      }
    }

    /* 본문: 검색 결과(왼쪽) | 지도(오른쪽) */
    .main-content {
      flex: 1;
      display: flex;
      min-height: 0;
    }
    .map-wrap {
      flex: 1;
      min-height: 200px;
      position: relative;
      min-width: 0;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 280px;
    }

    /* 셔틀 안내 메시지 (지도 상단, 노선·탑승장소 강조) */
    .shuttle-message {
      display: none;
      position: absolute;
      left: 50%;
      top: 16px;
      transform: translateX(-50%);
      max-width: 90%;
      padding: 14px 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,.15);
      z-index: 15;
      font-size: 18px;
      line-height: 1.5;
    }
    .shuttle-message.show { display: block; }
    .shuttle-message.dimmed { opacity: 0.35; transition: opacity 0.15s; }
    .shuttle-message .hl {
      font-weight: 700;
      color: #1565c0;
    }
    .shuttle-message .time-tag,
    .shuttle-point-label .time-tag {
      color: #0d47a1;
      font-weight: 600;
    }
    .shuttle-point-label .getoff-tag {
      color: #c62828;
      font-weight: 600;
      margin-left: 2px;
    }
    .shuttle-point-label .shuttle-point-name {
      white-space: nowrap;
    }
    .shuttle-point-label .time-tag,
    .shuttle-point-label .getoff-tag {
      display: block;
      margin-top: 4px;
      margin-left: 0;
    }

    /* 노선 없음 에러 메시지 (기존 안내 위에 임시 표시) */
    .shuttle-error-overlay {
      display: none;
      position: absolute;
      left: 50%;
      top: 16px;
      transform: translateX(-50%);
      max-width: 90%;
      padding: 14px 20px;
      background: #c62828;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,.2);
      z-index: 16;
      font-size: 18px;
      line-height: 1.5;
    }
    .shuttle-error-overlay.show { display: block; }
    @media (max-width: 768px) {
      .shuttle-error-overlay { max-width: 85%; font-size: 14px; padding: 10px 14px; }
    }

    /* 셔틀 지도: 핀은 정확한 위치에(래퍼 중앙=앵커), 장소명은 가급적 중앙·한 줄 */
    .shuttle-point-wrap {
      position: relative;
      width: 260px;
      height: 90px;
      z-index: 2;
    }
    .shuttle-point-pin {
      width: 24px;
      height: 24px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%234285F4" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><circle cx="12" cy="9.5" r="2.5" fill="%23fff"/></svg>') center/contain no-repeat;
      transform-origin: 50% 50%;
      transition: transform 0.15s ease;
      transform: scale(var(--pin-scale, 1));
    }
    .shuttle-label-anchor {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 18px;
      pointer-events: none;
    }
    .shuttle-point-label {
      background: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      border: 2px solid #000;
      box-shadow: 0 1px 4px rgba(0,0,0,.15);
      font-size: 15px;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
    }

    .results-panel {
      width: 320px;
      max-width: 40vw;
      flex-shrink: 0;
      background: #fff;
      box-shadow: 2px 0 12px rgba(0,0,0,.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-title-row {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    .results-panel .panel-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      flex: 1;
      min-width: 0;
    }
    .btn-back-from-routes {
      flex-shrink: 0;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #f0f0f0;
      color: #333;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-back-from-routes:hover {
      background: #e0e0e0;
    }
    .results-list-wrap {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior-y: contain;
    }
    .results-placeholder {
      padding: 24px 16px;
      color: #999;
      font-size: 14px;
      line-height: 1.5;
    }
    .results-list {
      display: flex;
      flex-direction: column;
      padding: 8px 0;
    }
    .result-card {
      flex-shrink: 0;
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background .15s, border-color .15s;
      border-left: 3px solid transparent;
    }
    .result-card:hover {
      background: #fffde7;
    }
    .result-card.highlight {
      background: #fffde7;
      border-left-color: #fee500;
    }
    .result-card.selected {
      background: #fff9c4;
      border-left-color: #fbc02d;
    }
    .result-card .name {
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .result-card .addr {
      font-size: 13px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-actions {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      gap: 8px;
    }
    .result-card.selected .card-actions { display: flex; }
    .card-actions button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .card-actions .btn-depart { background: #e3f2fd; color: #1565c0; }
    .card-actions .btn-arrive { background: #e8f5e9; color: #2e7d32; }

    .map-controls {
      position: absolute;
      right: 16px;
      bottom: 16px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .btn-zoom,
    .btn-location {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s, box-shadow .15s;
    }
    .btn-zoom:hover,
    .btn-location:hover {
      background: #f5f5f5;
      box-shadow: 0 2px 12px rgba(0,0,0,.2);
    }
    .btn-zoom svg,
    .btn-location svg { width: 24px; height: 24px; }

    .pin-marker {
      width: 32px;
      height: 32px;
      margin-left: -16px;
      margin-bottom: -32px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%234285F4" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><circle cx="12" cy="9.5" r="2.5" fill="%23fff"/></svg>') center/contain no-repeat;
      cursor: pointer;
      transition: transform 0.15s ease;
      transform-origin: 16px 32px;
      transform: scale(var(--pin-scale, 1));
    }
    .pin-marker.hover, .pin-marker.selected {
      transform: scale(var(--pin-scale, 1)) scale(1.4);
    }

    /* 말풍선 (마커 클릭 시) */
    .bubble-container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 500;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.15));
    }
    .bubble-container .bubble-tail-svg {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }
    .bubble-container .bubble-box {
      position: absolute;
      pointer-events: auto;
      padding: 12px 14px;
      background: #fff;
      border-radius: 10px;
      min-width: 180px;
      cursor: default;
      touch-action: manipulation;
    }
    .bubble-container .bubble-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .bubble-container .bubble-name { font-weight: 600; flex: 1; min-width: 0; }
    .bubble-container .bubble-close {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      background: transparent;
      color: #666;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bubble-container .bubble-close:hover {
      background: #f0f0f0;
      color: #333;
    }
    .bubble-container .bubble-close svg {
      width: 18px;
      height: 18px;
    }
    .bubble-container .bubble-addr { font-size: 12px; color: #666; margin-bottom: 10px; }
    .bubble-container .bubble-actions { display: flex; gap: 8px; }
    .bubble-container .bubble-actions button {
      flex: 1;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .bubble-container .btn-depart { background: #e3f2fd; color: #1565c0; }
    .bubble-container .btn-arrive { background: #e8f5e9; color: #2e7d32; }

    /* 현재 위치 마커 (지도 위 아이콘) */
    .current-location-marker {
      width: 28px;
      height: 28px;
      margin-left: -14px;
      margin-top: -14px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%231a73e8" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><circle cx="12" cy="9.5" r="2.5" fill="%23fff"/></svg>') center/contain no-repeat;
      pointer-events: none;
    }

    /* 정렬 토글 */
    .route-sort-bar {
      display: none;
      padding: 6px 16px;
      gap: 6px;
      align-items: center;
      position: relative;
    }
    .route-sort-bar.show {
      display: flex;
    }
    .route-sort-btn {
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: #fff;
      color: #888;
      cursor: pointer;
      transition: all .15s;
    }
    .route-sort-btn.active {
      background: #333;
      color: #fff;
      border-color: #333;
    }
    .route-sort-spacer {
      flex: 1;
      min-width: 8px;
    }
    .route-distance-trigger {
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: #fff;
      color: #555;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
    }
    .route-distance-trigger.active {
      border-color: #bbb;
      background: #f7f7f7;
    }
    .route-distance-popover {
      display: none;
      position: absolute;
      right: 16px;
      top: calc(100% + 6px);
      width: 220px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,.14);
      z-index: 12;
    }
    .route-distance-popover.show {
      display: block;
    }
    .route-distance-title {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }
    .route-distance-value {
      font-size: 13px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
      text-align: right;
    }
    .route-distance-slider {
      width: 100%;
      margin: 0;
    }
    .route-distance-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .route-distance-confirm {
      padding: 5px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      color: #333;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .route-distance-confirm:hover {
      background: #f5f5f5;
      border-color: #ccc;
    }
    @media (max-width: 768px) {
      .route-distance-popover {
        right: 8px;
        width: min(240px, calc(100vw - 40px));
      }
    }

    /* 노선 선택 리스트 (최대 5개) */
    .route-options-wrap {
      display: none;
      flex-direction: column;
      padding: 8px 0;
    }
    .route-options-wrap.show {
      display: flex;
    }
    .route-option-card {
      flex-shrink: 0;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      background: #fff;
      cursor: pointer;
      transition: background .15s, border-color .15s;
    }
    .route-option-card:hover {
      background: #f5f5f5;
      border-color: #fee500;
    }
    .route-option-card.selected {
      border-color: #fee500;
      background: #fffde7;
    }
    .route-option-card .route-name {
      font-weight: 700;
      font-size: 15px;
      color: #333;
    }
    .route-option-card .route-meta {
      font-size: 13px;
      color: #1e5a8e;
      margin-top: 4px;
    }
    .route-option-card .route-detail {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
      margin-top: 6px;
    }
    .route-option-card .card-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-option-card .card-main .card-title-wrap {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }
    .route-option-card .btn-route-detail {
      flex-shrink: 0;
      padding: 4px 10px;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .route-option-card .btn-route-detail:hover {
      background: #e8e8e8;
      border-color: #ccc;
    }
    .route-option-card.expanded .btn-route-detail {
      background: #fee500;
      border-color: #e6d000;
      color: #333;
    }
    .route-detail-panel {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .route-option-card.expanded .route-detail-panel {
      display: block;
    }
    .route-detail-panel .detail-title {
      font-size: 12px;
      font-weight: 700;
      color: #555;
      margin-bottom: 8px;
    }
    .route-detail-panel .departure-times {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 13px;
      color: #333;
    }
    .route-detail-panel .departure-times .time-item {
      padding: 2px 0;
    }
    .route-detail-panel .departure-times .time-item.current {
      font-weight: 700;
      color: #000;
    }
    .route-detail-panel .route-extra-info {
      font-size: 12px;
      color: #888;
      margin-top: 6px;
      line-height: 1.4;
    }
    .route-stops-divider {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 12px 0;
    }
    .route-stops-list {
      font-size: 13px;
      color: #444;
      line-height: 1.7;
    }
    .route-stop-item.highlight {
      color: #000;
    }
    .route-db-updated {
      font-size: 11px;
      color: #888;
      text-align: right;
      margin-top: 8px;
    }
    .btn-load-more-routes {
      display: block;
      width: 100%;
      padding: 12px 0;
      margin-top: 10px;
      border: 1px dashed #bbb;
      border-radius: 10px;
      background: #fafafa;
      color: #555;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }
    .btn-load-more-routes:active {
      background: #f0f0f0;
    }
    .btn-load-more-routes:disabled {
      color: #aaa;
      cursor: default;
    }

    /* 모바일: 레이아웃 전환 + 하단 시트 */
    @media (max-width: 768px) {
      .header {
        flex-wrap: wrap;
        gap: 10px;
      }
      .header.route-mode {
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px 12px;
      }
      .header.route-mode .route-mode-header {
        width: 100%;
        max-width: none;
        margin: 0;
      }
      .header-left {
        order: 2;
        flex: 1 1 0;
        min-width: 0;
      }
      .departure-trigger {
        width: 100%;
      }
      .header-center {
        order: 1;
        flex: 1 1 100%;
        max-width: none;
      }
      .search-bar {
        max-width: none;
        gap: 6px;
      }
      .search-bar input {
        min-width: 0;
        padding: 11px 12px;
        font-size: 14px;
      }
      .search-bar button {
        padding: 11px 12px;
      }
      .search-bar .issue-open-btn {
        width: 40px;
        min-width: 40px;
        font-size: 12px;
      }
      .site-selector-wrap {
        order: 3;
        flex: 1 1 0;
        min-width: 0;
      }
      .header.route-mode .header-left {
        order: 2;
        flex: 1 1 0;
      }
      .header.route-mode .site-selector-wrap {
        order: 2;
        flex: 0 0 auto;
      }
      .site-selector-wrap select { min-width: 0; width: 100%; }
      .site-selector-trigger {
        display: flex;
        width: 100%;
        max-width: none;
      }
      .header.route-mode .site-selector-trigger {
        width: auto;
        max-width: 52vw;
      }
      .route-mode-back-btn {
        height: 40px;
        width: 48px;
        min-width: 48px;
        padding: 0;
      }
      .route-mode-issue-btn {
        width: 40px;
        min-width: 40px;
        height: 40px;
        font-size: 12px;
      }
      .route-mode-place-label,
      .route-endpoint-trigger {
        min-height: 40px;
        font-size: 13px;
        padding: 9px 10px;
      }

      .main-content {
        position: relative;
      }
      .results-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: none;
        height: 50vh;
        max-height: 85vh;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,.15);
        z-index: 20;
        transition: height .25s ease, transform .25s ease;
      }
      .results-panel.sheet-peek {
        height: 72px;
      }
      .results-panel.sheet-half {
        height: 50vh;
      }
      .results-panel.sheet-full {
        height: 85vh;
      }
      .results-panel.sheet-dragging {
        transition: none;
      }
      .bottom-sheet-handle {
        display: block;
        flex-shrink: 0;
        width: 40px;
        height: 4px;
        margin: 10px auto 8px;
        background: #ccc;
        border-radius: 2px;
        cursor: grab;
        touch-action: none;
      }
      .panel-title-row {
        padding: 8px 16px 12px;
      }
      .results-list-wrap {
        flex: 1;
        min-height: 0;
      }
      .map-controls {
        right: 12px;
        bottom: calc(env(safe-area-inset-bottom) + 88px);
      }
      .btn-zoom {
        display: none;
      }
      .btn-location {
        width: 44px;
        height: 44px;
      }
    }
    @media (max-width: 768px) {
      .sheet-drag-area {
        flex-shrink: 0;
        min-height: 52px;
        cursor: grab;
        touch-action: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .sheet-drag-area:active { cursor: grabbing; }
    }
    @media (min-width: 769px) {
      .bottom-sheet-handle { display: none; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <button type="button" class="departure-trigger" id="departureTrigger" title="요일/출발시간 선택">
        <span class="trigger-text" id="departureTriggerText">평일 00:00 출발</span>
        <span class="trigger-arrow"></span>
      </button>
    </div>
    <div class="header-center">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="장소 검색 (예: 강남역 맛집)" autocomplete="off" enterkeyhint="done" />
        <button type="button" id="searchBtn">검색</button>
        <button type="button" class="issue-open-btn" id="issueModalTrigger" title="제보/이슈 보기">이슈</button>
      </div>
    </div>
    <div class="site-selector-wrap">
      <select id="siteSelect" title="사업장 선택" aria-hidden="true">
        <option value="0000013">삼성전자(수원)</option>
      </select>
      <button type="button" class="site-selector-trigger" id="siteSelectTrigger" title="사업장 선택" aria-expanded="false" aria-haspopup="listbox">
        <span class="site-trigger-text">삼성전자(수원)</span>
        <span class="site-trigger-arrow"></span>
      </button>
    </div>
    <div class="route-mode-header" id="routeModeHeader" aria-hidden="true">
      <div class="route-mode-topline">
        <div class="route-mode-left">
          <span class="route-mode-row-label">출발</span>
          <div class="route-mode-place-label" id="routeTopPlaceLabel"></div>
          <button type="button" class="route-endpoint-trigger route-mode-hidden" id="routeTopEndpointTrigger" aria-haspopup="dialog" aria-expanded="false">
            <span class="endpoint-trigger-text" id="routeTopEndpointTriggerText">선택</span>
            <span class="endpoint-trigger-arrow"></span>
          </button>
        </div>
        <div class="route-mode-actions">
          <button type="button" class="route-mode-back-btn" id="routeHeaderBackBtn">뒤로</button>
          <button type="button" class="route-mode-issue-btn" id="routeIssueModalTrigger" title="제보/이슈 보기">이슈</button>
        </div>
      </div>
      <div class="route-mode-secondline">
        <span class="route-mode-row-label">도착</span>
        <div class="route-mode-place-label route-mode-hidden" id="routeBottomPlaceLabel"></div>
        <button type="button" class="route-endpoint-trigger route-mode-hidden" id="routeBottomEndpointTrigger" aria-haspopup="dialog" aria-expanded="false">
          <span class="endpoint-trigger-text" id="routeBottomEndpointTriggerText">선택</span>
          <span class="endpoint-trigger-arrow"></span>
        </button>
      </div>
    </div>
  </header>

  <div class="time-picker-backdrop" id="timePickerBackdrop" aria-hidden="true"></div>
  <div class="time-picker-modal" id="timePickerModal" role="dialog" aria-label="요일/출발 시간 선택" style="top: 56px;">
    <div class="time-picker-header">
      <h2 class="time-picker-title">요일 / 출발 시간</h2>
      <div class="time-picker-actions">
        <button type="button" class="time-picker-five" id="timePickerFive">05:00</button>
        <button type="button" class="time-picker-now" id="timePickerNow">현재 시간</button>
      </div>
    </div>
    <div class="time-picker-wheels">
      <div class="time-picker-column day-type-column">
        <div class="time-picker-selection-band" aria-hidden="true"></div>
        <div class="time-picker-items" id="dayTypeList"></div>
      </div>
      <div class="time-picker-column">
        <div class="time-picker-selection-band" aria-hidden="true"></div>
        <div class="time-picker-items" id="timePickerHourList"></div>
      </div>
      <div class="time-picker-column">
        <div class="time-picker-selection-band" aria-hidden="true"></div>
        <div class="time-picker-items" id="timePickerMinuteList"></div>
      </div>
    </div>
    <button type="button" class="time-picker-confirm" id="timePickerConfirm">확인</button>
  </div>

  <div class="site-picker-backdrop" id="sitePickerBackdrop" aria-hidden="true"></div>
  <div class="site-picker-modal" id="sitePickerModal" role="dialog" aria-label="사업장 선택">
    <h2 class="site-picker-title">사업장 선택</h2>
    <div class="site-picker-list" id="sitePickerList" role="listbox"></div>
  </div>

  <div class="endpoint-picker-backdrop" id="endpointPickerBackdrop" aria-hidden="true"></div>
  <div class="endpoint-picker-modal" id="endpointPickerModal" role="dialog" aria-label="노선 endpoint 선택">
    <div class="endpoint-picker-title-row">
      <h2 class="endpoint-picker-title" id="endpointPickerTitle">선택</h2>
      <button type="button" class="endpoint-picker-confirm-btn" id="endpointPickerConfirmBtn">확인</button>
    </div>
    <div class="endpoint-picker-search-wrap">
      <input
        type="text"
        class="endpoint-picker-search-input"
        id="endpointPickerSearchInput"
        placeholder="정류장명 검색 (e.g., ㄱㅎㅋ)"
        autocomplete="off"
      />
    </div>
    <div class="endpoint-picker-list" id="endpointPickerList" role="listbox"></div>
  </div>

  <div class="location-permission-backdrop" id="locationPermissionBackdrop" aria-hidden="true"></div>
  <div class="location-permission-modal" id="locationPermissionModal" role="dialog" aria-label="위치 권한">
    <p class="location-permission-message" id="locationPermissionMessage"></p>
    <button type="button" class="location-permission-confirm" id="locationPermissionConfirm">확인</button>
  </div>

  <div class="issue-modal-backdrop" id="issueModalBackdrop" aria-hidden="true"></div>
  <div class="issue-modal" id="issueModal" role="dialog" aria-label="이슈/건의">
    <div class="issue-modal-header">
      <h2 class="issue-modal-title" id="issueModalTitle">이슈 / 건의</h2>
      <div class="issue-modal-header-actions">
        <button type="button" class="issue-compose-btn" id="issueComposeBtn">+건의하기</button>
        <button type="button" class="issue-close-btn" id="issueModalCloseBtn" aria-label="닫기">×</button>
      </div>
    </div>
    <div class="issue-modal-body">
      <div class="issue-feedback" id="issueFeedback"></div>

      <section class="issue-view show" id="issueListView" aria-label="이슈 목록">
        <div class="issue-list-controls">
          <select class="issue-state-filter" id="issueStateFilter" aria-label="이슈 상태 필터">
            <option value="all">전체</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="issue-list" id="issueList"></div>
        <div class="issue-pagination" id="issuePagination">
          <button type="button" class="issue-page-btn" id="issuePrevPageBtn">이전</button>
          <span class="issue-page-info" id="issuePageInfo">1페이지</span>
          <button type="button" class="issue-page-btn" id="issueNextPageBtn">다음</button>
        </div>
        <span class="issue-support-email">support@shuttle-go.com</span>
      </section>

      <section class="issue-view" id="issueDetailView" aria-label="이슈 상세">
        <button type="button" class="issue-back-btn" id="issueDetailBackBtn">← 목록으로</button>
        <div id="issueDetailContent"></div>
      </section>

      <section class="issue-view" id="issueFormView" aria-label="건의 등록">
        <form id="issueCreateForm">
          <div class="issue-form-group">
            <label for="issueTitleInput">제목</label>
            <input type="text" id="issueTitleInput" maxlength="120" placeholder="예: 노선 시간표가 실제와 달라요" required />
          </div>
          <div class="issue-form-group">
            <label for="issueBodyInput">내용</label>
            <textarea id="issueBodyInput" placeholder="불편했던 내용, 재현 방법, 원하는 개선점을 적어주세요." required></textarea>
            <p class="issue-form-help">작성 내용은 모든 사용자에게 공개됩니다.</p>
          </div>
          <div class="issue-form-group">
            <label for="issueNicknameInput">닉네임 (선택)</label>
            <input type="text" id="issueNicknameInput" maxlength="40" placeholder="예: 셔틀러버" />
          </div>
          <div class="issue-form-actions">
            <button type="button" class="issue-form-btn" id="issueFormCancelBtn">취소</button>
            <button type="submit" class="issue-form-btn primary" id="issueFormSubmitBtn">등록</button>
          </div>
        </form>
      </section>
    </div>
  </div>

  <main class="main-content">
    <div class="results-panel sheet-peek" id="resultsPanel">
      <div class="sheet-drag-area" id="sheetDragArea">
        <div class="bottom-sheet-handle" id="bottomSheetHandle" aria-hidden="true"></div>
        <div class="panel-title-row">
          <div class="panel-title" id="panelTitle">검색 결과</div>
          <button type="button" class="btn-back-from-routes" id="btnBackFromRoutes" style="display: none;">뒤로 가기</button>
        </div>
      </div>
      <div class="results-list-wrap">
        <div class="results-placeholder" id="resultsPlaceholder">검색어를 입력한 뒤 검색하면 여기에 표시됩니다.</div>
        <div class="results-list" id="resultsList" style="display: none;"></div>
        <div class="route-sort-bar" id="routeSortBar">
          <button type="button" class="route-sort-btn active" id="sortByDistance" data-sort="distance">거리순</button>
          <button type="button" class="route-sort-btn" id="sortByTime" data-sort="time">시간순</button>
          <div class="route-sort-spacer"></div>
          <button type="button" class="route-distance-trigger" id="maxDistanceTrigger" aria-haspopup="dialog" aria-expanded="false">최대 5 km 이내</button>
          <div class="route-distance-popover" id="maxDistancePopover" role="dialog" aria-hidden="true">
            <div class="route-distance-title">최대 정류장 거리</div>
            <div class="route-distance-value"><span id="maxDistanceValue">5</span> km</div>
            <input type="range" class="route-distance-slider" id="maxDistanceSlider" min="0" max="30" step="0.5" value="5" />
            <div class="route-distance-actions">
              <button type="button" class="route-distance-confirm" id="maxDistanceConfirm">확인</button>
            </div>
          </div>
        </div>
        <div class="route-options-wrap" id="routeOptionsWrap"></div>
      </div>
    </div>
    <div class="map-wrap">
      <div id="map"></div>
      <div class="shuttle-message" id="shuttleMessage"></div>
      <div class="shuttle-error-overlay" id="shuttleErrorOverlay"></div>
      <div class="map-controls">
        <button type="button" class="btn-zoom" id="btnZoomIn" title="확대">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
        </button>
        <button type="button" class="btn-zoom" id="btnZoomOut" title="축소">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
        </button>
        <button type="button" class="btn-location" id="btnLocation" title="내 위치">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="3"/>
            <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>
    </div>
  </main>

  <script src="dev.config.js"></script>
  <script>
    // ── 환경 설정 (dev / prd) ──────────────────────────────
    (function() {
      var host = location.hostname;
      var isDev = (
        host === 'localhost' ||
        host === '127.0.0.1' ||
        host.indexOf('192.168.') === 0
      );
      var devConfig = window.__SHUTTLE_DEV_CONFIG || {};
      function resolveDevApiBase() {
        var useHttps = (location.protocol === 'https:');
        var scheme = useHttps ? 'https' : 'http';
        var defaultPort = useHttps ? 443 : 80;
        var port = Number(useHttps ? devConfig.API_HTTPS_PORT : devConfig.API_HTTP_PORT);
        if (!port) port = defaultPort;
        if (!isFinite(port) || port < 1 || port > 65535) port = defaultPort;
        return (port === defaultPort) ? (scheme + '://' + host) : (scheme + '://' + host + ':' + port);
      }
      var ENV = {
        // 카카오 JavaScript 키: 각각 카카오 콘솔에서 허용 URL을 다르게 설정
        KAKAO_JS_KEY: isDev
          ? '22400d4577672b2419e494c2e292d9c0'   // dev: localhost 허용
          : '39fb0eced397ffdd52bc40427d8a1d91',  // prd: shuttlego.github.io 허용
        // 백엔드 API base URL
        API_BASE: isDev
          ? resolveDevApiBase()           // dev: Traefik (BACKEND_HTTP_PORT)
          : 'https://api.shuttle-go.com'  // prd: Traefik HTTPS
      };
      window.__SHUTTLE_ENV = ENV;

      // 카카오 지도 SDK 동적 로드
      var script = document.createElement('script');
      script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ENV.KAKAO_JS_KEY + '&autoload=false';
      script.onload = function() {
        kakao.maps.load(function() {
          if (window.__initShuttleApp) window.__initShuttleApp();
        });
      };
      document.head.appendChild(script);
    })();
  </script>
  <script>
    window.__initShuttleApp = function() {
      var ENV = window.__SHUTTLE_ENV;
      var API_BASE = ENV.API_BASE;
      var mapContainer = document.getElementById('map');
      var searchInput = document.getElementById('searchInput');
      var searchBtn = document.getElementById('searchBtn');
      var resultsPlaceholder = document.getElementById('resultsPlaceholder');
      var resultsList = document.getElementById('resultsList');
      var panelTitle = document.getElementById('panelTitle');
      var headerEl = document.querySelector('.header');
      var btnLocation = document.getElementById('btnLocation');
      var siteSelect = document.getElementById('siteSelect');
      var siteSelectTrigger = document.getElementById('siteSelectTrigger');
      var sitePickerBackdrop = document.getElementById('sitePickerBackdrop');
      var sitePickerModal = document.getElementById('sitePickerModal');
      var sitePickerList = document.getElementById('sitePickerList');
      var departureTrigger = document.getElementById('departureTrigger');
      var departureTriggerText = document.getElementById('departureTriggerText');
      var dayTypeList = document.getElementById('dayTypeList');
      var shuttleMessage = document.getElementById('shuttleMessage');
      var issueModalTrigger = document.getElementById('issueModalTrigger');
      var routeIssueModalTrigger = document.getElementById('routeIssueModalTrigger');
      var issueModalBackdrop = document.getElementById('issueModalBackdrop');
      var issueModal = document.getElementById('issueModal');
      var issueModalCloseBtn = document.getElementById('issueModalCloseBtn');
      var issueComposeBtn = document.getElementById('issueComposeBtn');
      var issueFeedback = document.getElementById('issueFeedback');
      var issueListView = document.getElementById('issueListView');
      var issueDetailView = document.getElementById('issueDetailView');
      var issueFormView = document.getElementById('issueFormView');
      var issueListEl = document.getElementById('issueList');
      var issueStateFilter = document.getElementById('issueStateFilter');
      var issuePrevPageBtn = document.getElementById('issuePrevPageBtn');
      var issueNextPageBtn = document.getElementById('issueNextPageBtn');
      var issuePageInfo = document.getElementById('issuePageInfo');
      var issueDetailBackBtn = document.getElementById('issueDetailBackBtn');
      var issueDetailContent = document.getElementById('issueDetailContent');
      var issueCreateForm = document.getElementById('issueCreateForm');
      var issueFormCancelBtn = document.getElementById('issueFormCancelBtn');
      var issueFormSubmitBtn = document.getElementById('issueFormSubmitBtn');
      var issueTitleInput = document.getElementById('issueTitleInput');
      var issueBodyInput = document.getElementById('issueBodyInput');
      var issueNicknameInput = document.getElementById('issueNicknameInput');
      var mapControls = document.querySelector('.map-controls');
      var routeModeHeader = document.getElementById('routeModeHeader');
      var routeTopPlaceLabel = document.getElementById('routeTopPlaceLabel');
      var routeBottomPlaceLabel = document.getElementById('routeBottomPlaceLabel');
      var routeTopEndpointTrigger = document.getElementById('routeTopEndpointTrigger');
      var routeBottomEndpointTrigger = document.getElementById('routeBottomEndpointTrigger');
      var routeTopEndpointTriggerText = document.getElementById('routeTopEndpointTriggerText');
      var routeBottomEndpointTriggerText = document.getElementById('routeBottomEndpointTriggerText');
      var routeHeaderBackBtn = document.getElementById('routeHeaderBackBtn');
      var endpointPickerBackdrop = document.getElementById('endpointPickerBackdrop');
      var endpointPickerModal = document.getElementById('endpointPickerModal');
      var endpointPickerTitle = document.getElementById('endpointPickerTitle');
      var endpointPickerConfirmBtn = document.getElementById('endpointPickerConfirmBtn');
      var endpointPickerList = document.getElementById('endpointPickerList');
      var endpointPickerSearchInput = document.getElementById('endpointPickerSearchInput');

      var map = null;
      var overlays = [];
      var markerElements = [];
      var places = [];
      var selectedSiteId = '0000013';
      var selectedDayType = 'weekday';
      var dbUpdatedAt = '';
      var selectedPlaceIndex = -1;
      var bubbleOverlay = null;
      var shuttleLine = null;
      var shuttlePointOverlays = [];
      var shuttlePointContents = [];
      var shuttlePositions = [];
      var hoverPlaceOverlay = null;
      var currentLocationOverlay = null;
      var mapClickIgnore = false;
      var mapTouchStart = null;
      var bubbleOpenedAt = 0;
      var bubbleClosedByOutsideAt = 0;
      var shuttleErrorHideTimer = null;
      var shuttleLabelAdjustTimer = null;
      var departureTime = { h: 0, m: 0 };
      var lastPlace = null;
      var lastShuttleType = null;
      var routeOptionsWrap = document.getElementById('routeOptionsWrap');
      var routeSortBar = document.getElementById('routeSortBar');
      var currentSortMode = 'distance';
      var maxDistanceTrigger = document.getElementById('maxDistanceTrigger');
      var maxDistancePopover = document.getElementById('maxDistancePopover');
      var maxDistanceSlider = document.getElementById('maxDistanceSlider');
      var maxDistanceValue = document.getElementById('maxDistanceValue');
      var maxDistanceConfirm = document.getElementById('maxDistanceConfirm');
      var maxDistanceKm = 5;
      var maxDistancePendingKm = 5;
      var resultsPanel = document.getElementById('resultsPanel');
      var panToVisibleCenterRafId = null;
      var ISSUE_PAGE_SIZE = 10;
      var issueCurrentPage = 1;
      var issueHasNextPage = false;
      var issueCurrentState = 'all';
      var issueCurrentView = 'list';
      var routeModeDirection = null;
      var routeModePlaceName = '';
      var endpointOptionsAll = [];
      var endpointOptions = [];
      var selectedEndpoints = new Set();
      var endpointDraftEndpoints = null;
      var endpointSearchKeyword = '';
      var endpointSearchTimer = null;
      var endpointSelectionByContext = {};
      var endpointContextKey = '';
      var routeRequestSerial = 0;
      var dayTypeRequestSerial = 0;
      if (maxDistanceSlider) {
        var initMaxDistance = parseFloat(maxDistanceSlider.value);
        if (isFinite(initMaxDistance)) {
          maxDistanceKm = initMaxDistance;
          maxDistancePendingKm = initMaxDistance;
        }
      }

      function isMobile() {
        return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
      }
      function updateMapControlsPosition() {
        if (!mapControls) return;
        // 위치는 CSS에서 고정 관리한다(모달 상태와 무관).
        mapControls.style.bottom = '';
      }
      function setSheetState(state) {
        if (!resultsPanel) return;
        resultsPanel.classList.remove('sheet-peek', 'sheet-half', 'sheet-full');
        if (state) resultsPanel.classList.add(state);
        updateMapControlsPosition();
        if (isMobile() && state) setTimeout(adjustMapForSheet, 80);
      }

      function adjustMapForSheet() {
        if (!isMobile() || !map) return;
        if (overlays.length === 0) return;
        var sheetHeight = parseFloat(window.getComputedStyle(resultsPanel).height, 10);
        if (isNaN(sheetHeight)) return;
        var bounds = new kakao.maps.LatLngBounds();
        overlays.forEach(function(o) { bounds.extend(o.getPosition()); });
        map.setBounds(bounds);
        map.panBy(0, Math.round(sheetHeight / 2));
      }

      function cloneStringSet(src) {
        var out = new Set();
        if (!src || typeof src.forEach !== 'function') return out;
        src.forEach(function(v) { out.add(v); });
        return out;
      }

      function getEndpointKindLabel(direction) {
        return direction === 'depart' ? '출근 종착지' : '퇴근 출발지';
      }

      function getEndpointContextKey(direction) {
        return selectedSiteId + '|' + selectedDayType + '|' + direction;
      }

      function isAllEndpointsSelected(selectionSet) {
        var setRef = selectionSet || selectedEndpoints;
        if (endpointOptionsAll.length === 0) return false;
        if (setRef.size !== endpointOptionsAll.length) return false;
        for (var i = 0; i < endpointOptionsAll.length; i++) {
          if (!setRef.has(endpointOptionsAll[i].endpoint_name)) return false;
        }
        return true;
      }

      function areStringSetsEqual(a, b) {
        if (a === b) return true;
        if (!a || !b) return false;
        if (a.size !== b.size) return false;
        var ok = true;
        a.forEach(function(v) {
          if (!b.has(v)) ok = false;
        });
        return ok;
      }

      function getSelectedEndpointRouteCount() {
        if (endpointOptionsAll.length === 0 || selectedEndpoints.size === 0) return 0;
        var sum = 0;
        endpointOptionsAll.forEach(function(opt) {
          if (selectedEndpoints.has(opt.endpoint_name)) {
            sum += (opt.route_count || 0);
          }
        });
        return sum;
      }

      function getSelectedEndpointNamesSorted() {
        var names = [];
        selectedEndpoints.forEach(function(name) { names.push(name); });
        names.sort(function(a, b) { return a.localeCompare(b, 'ko'); });
        return names;
      }

      function getEndpointOptionComponents(opt) {
        if (opt && Array.isArray(opt.endpoint_components) && opt.endpoint_components.length > 0) {
          return opt.endpoint_components
            .map(function(name) { return String(name || '').trim(); })
            .filter(function(name) { return name.length > 0; });
        }
        var fromDisplay = String((opt && opt.endpoint_display_name) || '');
        if (fromDisplay) {
          var parsed = fromDisplay
            .split('\n')
            .map(function(name) { return String(name || '').trim(); })
            .filter(function(name) { return name.length > 0; });
          if (parsed.length > 0) return parsed;
        }
        var raw = String((opt && opt.endpoint_name) || '');
        if (!raw) return [];
        return raw
          .split(' / ')
          .map(function(name) { return name.trim(); })
          .filter(function(name) { return name.length > 0; });
      }

      function getEndpointOptionPrimaryName(opt) {
        var primary = String((opt && opt.endpoint_primary_name) || '').trim();
        if (primary) return primary;
        var components = getEndpointOptionComponents(opt);
        return components.length > 0 ? components[0] : String((opt && opt.endpoint_name) || '');
      }

      function getEndpointOptionDisplayText(opt) {
        var primary = getEndpointOptionPrimaryName(opt);
        var components = getEndpointOptionComponents(opt);
        if (!primary && components.length === 0) return String((opt && opt.endpoint_name) || '');

        var uniq = [];
        var seen = {};
        function pushUnique(name) {
          var n = String(name || '').trim();
          if (!n || seen[n]) return;
          seen[n] = true;
          uniq.push(n);
        }
        pushUnique(primary);
        components.forEach(pushUnique);

        if (uniq.length === 0) return String((opt && opt.endpoint_name) || '');
        var head = uniq[0];
        var remainder = uniq.slice(1).sort(function(a, b) { return a.localeCompare(b, 'ko'); });
        var lines = [head];
        remainder.forEach(function(name) { lines.push('  ' + name); });
        return lines.join('\n');
      }

      function findCaseInsensitiveMatchRange(text, keyword) {
        var src = String(text || '');
        var q = String(keyword || '').trim();
        if (!src || !q) return null;
        var idx = src.toLocaleLowerCase().indexOf(q.toLocaleLowerCase());
        if (idx < 0) return null;
        return [idx, idx + q.length];
      }

      function findChoseongMatchRange(text, choseongKeyword) {
        var src = String(text || '');
        var q = String(choseongKeyword || '').trim();
        if (!src || !q) return null;

        var seq = '';
        var seqCharIndices = [];
        for (var i = 0; i < src.length; i++) {
          var ch = src.charAt(i);
          var code = src.charCodeAt(i);
          var token = '';
          if (code >= HANGUL_BASE_CODE && code <= HANGUL_LAST_CODE) {
            var choseongIndex = Math.floor((code - HANGUL_BASE_CODE) / 588);
            token = CHOSEONG_LIST[choseongIndex] || '';
          } else if (code >= 0x3131 && code <= 0x314E) {
            token = ch;
          } else if (/\s/.test(ch)) {
            token = '';
          } else {
            token = ch.toLocaleLowerCase();
          }
          if (!token) continue;
          seq += token;
          seqCharIndices.push(i);
        }

        var idx = seq.indexOf(q);
        if (idx < 0) return null;
        var start = seqCharIndices[idx];
        var end = seqCharIndices[idx + q.length - 1] + 1;
        return [start, end];
      }

      function getEndpointLineHighlightedHtml(text) {
        var src = String(text || '');
        if (!src) return '';
        var keywordRaw = String(endpointSearchKeyword || '').trim();
        if (!keywordRaw) return escapeHtml(src);

        var range = findCaseInsensitiveMatchRange(src, keywordRaw);
        if (!range) {
          var compactKeyword = keywordRaw.replace(/\s+/g, '');
          if (isChoseongOnlyKeyword(compactKeyword)) {
            range = findChoseongMatchRange(src, compactKeyword);
          }
        }
        if (!range) return escapeHtml(src);

        var start = range[0];
        var end = range[1];
        if (start < 0 || end <= start || end > src.length) return escapeHtml(src);
        return (
          escapeHtml(src.slice(0, start)) +
          '<mark class="endpoint-keyword-highlight">' + escapeHtml(src.slice(start, end)) + '</mark>' +
          escapeHtml(src.slice(end))
        );
      }

      function getEndpointOptionLabelHtml(opt) {
        var displayText = getEndpointOptionDisplayText(opt);
        if (!displayText) return '';
        var lines = displayText
          .split('\n')
          .map(function(line) { return String(line || '').trim(); })
          .filter(function(line) { return line.length > 0; });
        if (lines.length === 0) return escapeHtml(displayText);

        var html = '<span class="endpoint-label-line endpoint-label-line-primary">' + getEndpointLineHighlightedHtml(lines[0]) + '</span>';
        for (var i = 1; i < lines.length; i++) {
          var cls = 'endpoint-label-line endpoint-label-line-sub' + (i === 1 ? ' first-sub' : '');
          html += '<span class="' + cls + '">&nbsp;&nbsp;' + getEndpointLineHighlightedHtml(lines[i]) + '</span>';
        }
        return html;
      }

      function getEndpointTriggerSummaryText() {
        if (endpointOptionsAll.length === 0) return '선택 옵션 없음';
        if (selectedEndpoints.size === 0) return '선택 없음';
        var selectedOptions = endpointOptionsAll.filter(function(opt) {
          return selectedEndpoints.has(opt.endpoint_name);
        });
        if (selectedOptions.length === 0) return '선택 없음';
        selectedOptions.sort(function(a, b) {
          var diff = (b.route_count || 0) - (a.route_count || 0);
          if (diff !== 0) return diff;
          return a.endpoint_name.localeCompare(b.endpoint_name, 'ko');
        });
        var head = getEndpointOptionPrimaryName(selectedOptions[0]);
        if (!head) return '선택 없음';
        var seenStops = {};
        var totalStops = 0;
        selectedOptions.forEach(function(opt) {
          var components = getEndpointOptionComponents(opt);
          if (!components || components.length === 0) {
            components = [getEndpointOptionPrimaryName(opt)];
          }
          components.forEach(function(name) {
            var stopName = String(name || '').trim();
            if (!stopName) return;
            if (seenStops[stopName]) return;
            seenStops[stopName] = true;
            totalStops += 1;
          });
        });
        var extraCount = Math.max(0, totalStops - 1);
        if (extraCount === 0) return head;
        return head + ' 외 ' + extraCount + '개';
      }

      var HANGUL_BASE_CODE = 0xAC00;
      var HANGUL_LAST_CODE = 0xD7A3;
      var CHOSEONG_LIST = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

      function extractHangulChoseong(text) {
        var src = String(text || '');
        var out = '';
        for (var i = 0; i < src.length; i++) {
          var ch = src.charAt(i);
          var code = src.charCodeAt(i);
          if (code >= HANGUL_BASE_CODE && code <= HANGUL_LAST_CODE) {
            var choseongIndex = Math.floor((code - HANGUL_BASE_CODE) / 588);
            out += CHOSEONG_LIST[choseongIndex] || '';
            continue;
          }
          if (code >= 0x3131 && code <= 0x314E) {
            out += ch;
            continue;
          }
          if (/\s/.test(ch)) continue;
          out += ch.toLocaleLowerCase();
        }
        return out;
      }

      function normalizeEndpointSearchText(text) {
        return String(text || '')
          .toLocaleLowerCase()
          .replace(/\s+/g, ' ')
          .trim();
      }

      function getEndpointOptionSearchText(opt) {
        var parts = [];
        var primary = String((opt && opt.endpoint_primary_name) || '').trim();
        if (primary) parts.push(primary);
        if (opt && Array.isArray(opt.endpoint_components) && opt.endpoint_components.length > 0) {
          opt.endpoint_components.forEach(function(name) {
            var n = String(name || '').trim();
            if (n) parts.push(n);
          });
        }
        var display = String((opt && opt.endpoint_display_name) || '').replace(/\n/g, ' ').trim();
        if (display) parts.push(display);
        var endpointName = String((opt && opt.endpoint_name) || '').replace(/\//g, ' ').trim();
        if (endpointName) parts.push(endpointName);
        return normalizeEndpointSearchText(parts.join(' '));
      }

      function mapEndpointOption(item) {
        var mapped = {
          endpoint_name: String(item.endpoint_name || ''),
          route_count: Number(item.route_count || 0),
          endpoint_primary_name: String(item.endpoint_primary_name || ''),
          endpoint_display_name: String(item.endpoint_display_name || ''),
          endpoint_components: Array.isArray(item.endpoint_components)
            ? item.endpoint_components
                .map(function(name) { return String(name || '').trim(); })
                .filter(function(name) { return name.length > 0; })
            : []
        };
        mapped._search_text = getEndpointOptionSearchText(mapped);
        mapped._search_choseong = extractHangulChoseong(mapped._search_text);
        return mapped;
      }

      function resetEndpointSearch() {
        endpointSearchKeyword = '';
        if (endpointSearchTimer) {
          clearTimeout(endpointSearchTimer);
          endpointSearchTimer = null;
        }
        endpointOptions = endpointOptionsAll.slice();
        if (endpointPickerSearchInput) endpointPickerSearchInput.value = '';
      }

      function isChoseongOnlyKeyword(keyword) {
        return /^[ㄱ-ㅎ]+$/.test(keyword);
      }

      function applyEndpointRouteKeywordSearch(keyword) {
        var normalized = String(keyword || '').trim();
        endpointSearchKeyword = normalized;
        var keywordNorm = normalizeEndpointSearchText(normalized);
        if (!keywordNorm) {
          endpointOptions = endpointOptionsAll.slice();
          renderEndpointPickerList();
          return Promise.resolve();
        }

        var choseongKeyword = normalized.replace(/\s+/g, '');
        var useChoseong = isChoseongOnlyKeyword(choseongKeyword);
        endpointOptions = endpointOptionsAll.filter(function(opt) {
          var searchText = String(opt._search_text || '');
          if (searchText.indexOf(keywordNorm) !== -1) return true;
          if (!useChoseong) return false;
          var searchChoseong = String(opt._search_choseong || '');
          return searchChoseong.indexOf(choseongKeyword) !== -1;
        });
        renderEndpointPickerList();
        return Promise.resolve();
      }

      function setEndpointTriggerEnabled(enabled) {
        if (routeTopEndpointTrigger) routeTopEndpointTrigger.disabled = !enabled;
        if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.disabled = !enabled;
      }

      function updateEndpointTriggerText() {
        var text = getEndpointTriggerSummaryText();
        if (routeTopEndpointTriggerText) routeTopEndpointTriggerText.textContent = text;
        if (routeBottomEndpointTriggerText) routeBottomEndpointTriggerText.textContent = text;
      }

      function persistCurrentEndpointSelection() {
        if (!endpointContextKey) return;
        endpointSelectionByContext[endpointContextKey] = {
          selected: cloneStringSet(selectedEndpoints)
        };
      }

      function applyEndpointPickerSelection() {
        if (!endpointDraftEndpoints) return false;
        var changed = !areStringSetsEqual(selectedEndpoints, endpointDraftEndpoints);
        if (changed) {
          selectedEndpoints = cloneStringSet(endpointDraftEndpoints);
          persistCurrentEndpointSelection();
          updateEndpointTriggerText();
        }
        endpointDraftEndpoints = null;
        return changed;
      }

      function closeEndpointPickerModal(opts) {
        opts = opts || {};
        var shouldApplySelection = opts.applySelection !== false;
        var shouldRefreshOnApply = opts.refreshOnApply !== false;
        var changed = false;
        if (shouldApplySelection) {
          changed = applyEndpointPickerSelection();
        } else {
          endpointDraftEndpoints = null;
        }

        if (endpointPickerBackdrop) endpointPickerBackdrop.classList.remove('show');
        if (endpointPickerModal) endpointPickerModal.classList.remove('show');
        if (routeTopEndpointTrigger) routeTopEndpointTrigger.setAttribute('aria-expanded', 'false');
        if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.setAttribute('aria-expanded', 'false');
        if (changed && shouldRefreshOnApply) refreshForEndpointSelectionChange();
      }

      function refreshForEndpointSelectionChange() {
        if (!routeModeDirection || !lastPlace) return;
        refreshLastShuttleResult({ preserveSheetState: isMobile() });
      }

      function renderEndpointPickerList() {
        if (!endpointPickerList) return;
        endpointPickerList.innerHTML = '';
        var activeSelection = endpointDraftEndpoints || selectedEndpoints;

        var listHeader = document.createElement('div');
        listHeader.className = 'endpoint-picker-list-header';

        var allBtn = document.createElement('button');
        allBtn.type = 'button';
        allBtn.className = 'endpoint-picker-all-toggle' + (isAllEndpointsSelected(activeSelection) ? ' selected' : '');
        allBtn.textContent = '전체 선택';
        allBtn.addEventListener('click', function() {
          if (isAllEndpointsSelected(activeSelection)) {
            endpointDraftEndpoints = new Set();
          } else {
            var all = new Set();
            endpointOptionsAll.forEach(function(opt) { all.add(opt.endpoint_name); });
            endpointDraftEndpoints = all;
          }
          renderEndpointPickerList();
        });
        listHeader.appendChild(allBtn);

        var countLabel = document.createElement('span');
        countLabel.className = 'endpoint-picker-list-count-label';
        countLabel.textContent = '노선 수';
        listHeader.appendChild(countLabel);

        endpointPickerList.appendChild(listHeader);

        if (endpointOptions.length === 0) {
          var emptyEl = document.createElement('div');
          emptyEl.className = 'endpoint-picker-empty';
          emptyEl.textContent = endpointSearchKeyword
            ? '키워드에 일치하는 옵션이 없습니다.'
            : '선택 가능한 옵션이 없습니다.';
          endpointPickerList.appendChild(emptyEl);
          return;
        }

        endpointOptions.forEach(function(opt) {
          var selected = activeSelection.has(opt.endpoint_name);
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'endpoint-picker-item' + (selected ? ' selected' : '');
          btn.setAttribute('role', 'option');
          btn.setAttribute('aria-selected', selected ? 'true' : 'false');
          var labelHtml = getEndpointOptionLabelHtml(opt);
          btn.innerHTML =
            '<span class="endpoint-item-main">' +
              '<span class="endpoint-item-check">v</span>' +
              '<span class="endpoint-item-label">' + labelHtml + '</span>' +
            '</span>' +
            '<span class="endpoint-item-meta">' + (opt.route_count || 0) + '</span>';
          btn.addEventListener('click', function() {
            if (!endpointDraftEndpoints) endpointDraftEndpoints = cloneStringSet(activeSelection);
            if (endpointDraftEndpoints.has(opt.endpoint_name)) endpointDraftEndpoints.delete(opt.endpoint_name);
            else endpointDraftEndpoints.add(opt.endpoint_name);
            renderEndpointPickerList();
          });
          endpointPickerList.appendChild(btn);
        });
      }

      function getActiveEndpointTriggerElement() {
        if (!routeTopEndpointTrigger || !routeBottomEndpointTrigger) return null;
        if (!routeTopEndpointTrigger.classList.contains('route-mode-hidden')) return routeTopEndpointTrigger;
        if (!routeBottomEndpointTrigger.classList.contains('route-mode-hidden')) return routeBottomEndpointTrigger;
        return null;
      }

      function openEndpointPickerModal() {
        if (!routeModeDirection || !endpointPickerBackdrop || !endpointPickerModal || !endpointPickerList) return;
        var kindLabel = getEndpointKindLabel(routeModeDirection);
        if (endpointPickerTitle) endpointPickerTitle.textContent = kindLabel + ' 선택';
        endpointDraftEndpoints = cloneStringSet(selectedEndpoints);
        if (endpointPickerSearchInput) endpointPickerSearchInput.value = endpointSearchKeyword;
        renderEndpointPickerList();

        var trigger = getActiveEndpointTriggerElement();
        if (isMobile()) {
          endpointPickerModal.style.top = '';
          endpointPickerModal.style.left = '';
          endpointPickerModal.style.right = '';
          endpointPickerModal.style.bottom = '0';
        } else if (trigger) {
          var rect = trigger.getBoundingClientRect();
          endpointPickerModal.style.top = (rect.bottom + 4) + 'px';
          endpointPickerModal.style.left = rect.left + 'px';
          endpointPickerModal.style.right = 'auto';
          endpointPickerModal.style.bottom = 'auto';
        }

        endpointPickerBackdrop.classList.add('show');
        endpointPickerModal.classList.add('show');
        if (routeTopEndpointTrigger) routeTopEndpointTrigger.setAttribute('aria-expanded', 'true');
        if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.setAttribute('aria-expanded', 'true');
      }

      function updateRouteModeHeader() {
        if (!routeModeHeader) return;
        var placeText = routeModePlaceName || '선택한 위치';
        if (routeTopPlaceLabel) routeTopPlaceLabel.textContent = placeText;
        if (routeBottomPlaceLabel) routeBottomPlaceLabel.textContent = placeText;
        updateEndpointTriggerText();

        if (routeModeDirection === 'depart') {
          if (routeTopPlaceLabel) routeTopPlaceLabel.classList.remove('route-mode-hidden');
          if (routeTopEndpointTrigger) routeTopEndpointTrigger.classList.add('route-mode-hidden');
          if (routeBottomPlaceLabel) routeBottomPlaceLabel.classList.add('route-mode-hidden');
          if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.classList.remove('route-mode-hidden');
        } else if (routeModeDirection === 'arrive') {
          if (routeTopPlaceLabel) routeTopPlaceLabel.classList.add('route-mode-hidden');
          if (routeTopEndpointTrigger) routeTopEndpointTrigger.classList.remove('route-mode-hidden');
          if (routeBottomPlaceLabel) routeBottomPlaceLabel.classList.remove('route-mode-hidden');
          if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.classList.add('route-mode-hidden');
        } else {
          if (routeTopPlaceLabel) routeTopPlaceLabel.classList.remove('route-mode-hidden');
          if (routeTopEndpointTrigger) routeTopEndpointTrigger.classList.add('route-mode-hidden');
          if (routeBottomPlaceLabel) routeBottomPlaceLabel.classList.add('route-mode-hidden');
          if (routeBottomEndpointTrigger) routeBottomEndpointTrigger.classList.add('route-mode-hidden');
        }
      }

      function setRouteMode(active, direction, placeName) {
        if (active) {
          routeModeDirection = direction || routeModeDirection || 'depart';
          routeModePlaceName = placeName || routeModePlaceName || '선택한 위치';
          if (headerEl) headerEl.classList.add('route-mode');
          if (routeModeHeader) routeModeHeader.setAttribute('aria-hidden', 'false');
          updateRouteModeHeader();
          return;
        }
        routeModeDirection = null;
        routeModePlaceName = '';
        endpointOptionsAll = [];
        endpointOptions = [];
        selectedEndpoints = new Set();
        endpointDraftEndpoints = null;
        endpointContextKey = '';
        resetEndpointSearch();
        if (headerEl) headerEl.classList.remove('route-mode');
        if (routeModeHeader) routeModeHeader.setAttribute('aria-hidden', 'true');
        closeEndpointPickerModal({ applySelection: false, refreshOnApply: false });
      }

      function loadEndpointOptions(direction) {
        var contextKey = getEndpointContextKey(direction);
        endpointContextKey = contextKey;
        var kindLabel = getEndpointKindLabel(direction);
        if (routeTopEndpointTriggerText) routeTopEndpointTriggerText.textContent = kindLabel + ' 불러오는 중...';
        if (routeBottomEndpointTriggerText) routeBottomEndpointTriggerText.textContent = kindLabel + ' 불러오는 중...';
        setEndpointTriggerEnabled(false);

        var url = API_BASE + '/api/shuttle/endpoint-options' +
          '?site_id=' + encodeURIComponent(selectedSiteId) +
          '&day_type=' + encodeURIComponent(selectedDayType);

        return fetch(url)
          .then(function(r) {
            return r.json().catch(function() { return {}; }).then(function(data) {
              return { ok: r.ok, data: data };
            });
          })
          .then(function(result) {
            if (!result.ok) {
              throw new Error(result.data.error || (kindLabel + ' 옵션을 불러오지 못했습니다.'));
            }

            var payload = result.data || {};
            var rawOptions = direction === 'depart'
              ? (payload.depart_terminus_options || [])
              : (payload.arrive_start_options || []);

            endpointOptionsAll = rawOptions
              .map(mapEndpointOption)
              .filter(function(item) { return item.endpoint_name.length > 0; })
              .sort(function(a, b) { return a.endpoint_name.localeCompare(b.endpoint_name, 'ko'); });
            resetEndpointSearch();

            var prevState = endpointSelectionByContext[contextKey];
            var available = new Set(endpointOptionsAll.map(function(item) { return item.endpoint_name; }));
            var nextSelected = new Set();
            if (prevState && prevState.selected && typeof prevState.selected.forEach === 'function') {
              prevState.selected.forEach(function(name) {
                if (available.has(name)) nextSelected.add(name);
              });
            } else {
              endpointOptionsAll.forEach(function(item) { nextSelected.add(item.endpoint_name); });
            }

            selectedEndpoints = nextSelected;
            endpointDraftEndpoints = null;
            persistCurrentEndpointSelection();
            updateEndpointTriggerText();
            updateRouteModeHeader();
            return endpointOptions;
          })
          .finally(function() {
            setEndpointTriggerEnabled(true);
          });
      }

      function pad2(n) { return (n < 10 ? '0' : '') + n; }
      function getDepartureTimeStr() { return pad2(departureTime.h) + ':' + pad2(departureTime.m); }
      function setDepartureFromDate(d) {
        departureTime.h = d.getHours();
        departureTime.m = d.getMinutes();
      }
      function updateDepartureTriggerText() {
        if (!departureTriggerText) return;
        var timeStr = getDepartureTimeStr();
        var dayLabel = DAY_TYPE_LABEL_MAP[selectedDayType] || selectedDayType || '평일';
        var shortLabel = DAY_TYPE_SHORT_MAP[selectedDayType] || dayLabel;
        // 공간에 따라 축약: 1) "요일 HH:MM 출발" 2) "요일 HH:MM" 3) "(축약) HH:MM"
        // 컨테이너 너비로 판단하기 어려우므로 CSS text-overflow에 의존하되,
        // data 속성에 단계별 텍스트를 넣어 ResizeObserver로 전환
        departureTriggerText.setAttribute('data-full', dayLabel + ' ' + timeStr + '분 출발');
        departureTriggerText.setAttribute('data-mid', shortLabel + ' ' + timeStr + '분 출발');
        departureTriggerText.setAttribute('data-compact', shortLabel + ' ' + timeStr + '분');
        departureTriggerText.setAttribute('data-short', shortLabel + ' ' + timeStr);
        fitDepartureTrigger();
      }
      function fitDepartureTrigger() {
        if (!departureTriggerText || !departureTrigger) return;
        var levels = [
          departureTriggerText.getAttribute('data-full') || '',
          departureTriggerText.getAttribute('data-mid') || '',
          departureTriggerText.getAttribute('data-compact') || '',
          departureTriggerText.getAttribute('data-short') || ''
        ];

        // 데스크톱에서는 버튼이 컨텐츠에 맞게 줄어드므로 항상 full
        if (!isMobile()) {
          departureTriggerText.textContent = levels[0];
          return;
        }

        // 모바일: 부모(.header-left)의 너비를 기준으로 측정
        var parent = departureTrigger.parentElement;
        if (!parent) { departureTriggerText.textContent = levels[0]; return; }
        var arrowWidth = 16; // arrow + gap
        var padding = 24; // 좌우 패딩
        var maxW = parent.clientWidth - arrowWidth - padding - 2; // border

        var canvas = fitDepartureTrigger._canvas || (fitDepartureTrigger._canvas = document.createElement('canvas'));
        var ctx = canvas.getContext('2d');
        var style = window.getComputedStyle(departureTriggerText);
        ctx.font = style.fontWeight + ' ' + style.fontSize + ' ' + style.fontFamily;

        var chosen = levels[levels.length - 1];
        for (var i = 0; i < levels.length; i++) {
          if (ctx.measureText(levels[i]).width <= maxW) {
            chosen = levels[i];
            break;
          }
        }
        departureTriggerText.textContent = chosen;
      }
      // 이전 코드 호환 wrapper
      function updateDepartureClockDisplay() { updateDepartureTriggerText(); }
      function parseTimeInput(val) {
        var s = (val || '').trim();
        if (!/^\d{1,2}:\d{1,2}$/.test(s)) return null;
        var parts = s.split(':');
        var h = parseInt(parts[0], 10);
        var m = parseInt(parts[1], 10);
        if (h < 0 || h > 23 || m < 0 || m > 59) return null;
        return { h: h, m: m };
      }
      var timePickerBackdrop = document.getElementById('timePickerBackdrop');
      var timePickerModal = document.getElementById('timePickerModal');
      var timePickerHourList = document.getElementById('timePickerHourList');
      var timePickerMinuteList = document.getElementById('timePickerMinuteList');
      var timePickerConfirm = document.getElementById('timePickerConfirm');
      var timePickerFive = document.getElementById('timePickerFive');
      var timePickerNow = document.getElementById('timePickerNow');
      var locationPermissionBackdrop = document.getElementById('locationPermissionBackdrop');
      var locationPermissionModal = document.getElementById('locationPermissionModal');
      var locationPermissionMessage = document.getElementById('locationPermissionMessage');
      var locationPermissionConfirm = document.getElementById('locationPermissionConfirm');
      var ITEM_HEIGHT = 40;
      var DAY_TYPE_ITEM_HEIGHT = 56;
      var PAD_HEIGHT = 60;
      var WHEEL_HEIGHT = 160;

      function buildTimePickerWheels() {
        if (!timePickerHourList || !timePickerMinuteList) return;
        function pad(n, len) { var s = String(n); while (s.length < len) s = '0' + s; return s; }
        timePickerHourList.innerHTML = '';
        var padTop = document.createElement('div');
        padTop.className = 'time-picker-pad';
        timePickerHourList.appendChild(padTop);
        for (var h = 0; h < 24; h++) {
          var el = document.createElement('div');
          el.className = 'time-picker-item';
          el.setAttribute('data-value', h);
          el.textContent = pad(h, 2);
          timePickerHourList.appendChild(el);
        }
        var padBottom = document.createElement('div');
        padBottom.className = 'time-picker-pad';
        timePickerHourList.appendChild(padBottom);

        timePickerMinuteList.innerHTML = '';
        var padTopM = document.createElement('div');
        padTopM.className = 'time-picker-pad';
        timePickerMinuteList.appendChild(padTopM);
        for (var m = 0; m < 60; m++) {
          var el = document.createElement('div');
          el.className = 'time-picker-item';
          el.setAttribute('data-value', m);
          el.textContent = pad(m, 2);
          timePickerMinuteList.appendChild(el);
        }
        var padBottomM = document.createElement('div');
        padBottomM.className = 'time-picker-pad';
        timePickerMinuteList.appendChild(padBottomM);
      }
      function getTimePickerScrollIndex(el, maxIndex) {
        if (!el) return 0;
        var scrollTop = el.scrollTop;
        var index = Math.round(scrollTop / ITEM_HEIGHT);
        return Math.max(0, Math.min(maxIndex, index));
      }
      function updateTimePickerSelectedClasses() {
        var h = getTimePickerScrollIndex(timePickerHourList, 23);
        var m = getTimePickerScrollIndex(timePickerMinuteList, 59);
        if (timePickerHourList) {
          timePickerHourList.querySelectorAll('.time-picker-item').forEach(function(item, i) {
            item.classList.toggle('selected', i === h);
          });
        }
        if (timePickerMinuteList) {
          timePickerMinuteList.querySelectorAll('.time-picker-item').forEach(function(item, i) {
            item.classList.toggle('selected', i === m);
          });
        }
      }
      function openTimePickerModal() {
        if (!timePickerBackdrop || !timePickerModal) return;
        buildTimePickerWheels();
        pendingDayType = selectedDayType;
        buildDayTypeWheel();
        var triggerEl = departureTrigger;
        if (isMobile()) {
          timePickerModal.style.top = '';
          timePickerModal.style.left = '';
          timePickerModal.style.right = '';
          timePickerModal.style.bottom = '0';
        } else {
          if (triggerEl) {
            var rect = triggerEl.getBoundingClientRect();
            timePickerModal.style.top = (rect.bottom + 4) + 'px';
            timePickerModal.style.left = rect.left + 'px';
            timePickerModal.style.right = 'auto';
            timePickerModal.style.bottom = 'auto';
          }
        }
        timePickerBackdrop.classList.add('show');
        timePickerModal.classList.add('show');
        requestAnimationFrame(function() {
          scrollDayTypeToValue(pendingDayType);
          timePickerHourList.scrollTop = departureTime.h * ITEM_HEIGHT;
          timePickerMinuteList.scrollTop = departureTime.m * ITEM_HEIGHT;
          updateDayTypeSelectedClasses();
          updateTimePickerSelectedClasses();
        });
      }
      function closeTimePickerModal() {
        if (timePickerBackdrop) timePickerBackdrop.classList.remove('show');
        if (timePickerModal) timePickerModal.classList.remove('show');
      }
      function setTimePickerToNow() {
        var now = new Date();
        var h = now.getHours();
        var m = now.getMinutes();
        if (timePickerHourList) timePickerHourList.scrollTop = h * ITEM_HEIGHT;
        if (timePickerMinuteList) timePickerMinuteList.scrollTop = m * ITEM_HEIGHT;
        updateTimePickerSelectedClasses();
        // 평일이 보이면 평일, 아니면 현재 표시 가능한 첫 번째 요일 사용
        var hasWeekday = DAY_TYPE_OPTIONS.some(function(opt) { return opt.value === 'weekday'; });
        pendingDayType = hasWeekday
          ? 'weekday'
          : (DAY_TYPE_OPTIONS.length > 0 ? DAY_TYPE_OPTIONS[0].value : selectedDayType);
        scrollDayTypeToValue(pendingDayType);
        updateDayTypeSelectedClasses();
      }
      function setTimePickerToFive() {
        if (timePickerHourList) timePickerHourList.scrollTop = 5 * ITEM_HEIGHT;
        if (timePickerMinuteList) timePickerMinuteList.scrollTop = 0;
        updateTimePickerSelectedClasses();
      }
      function applyTimePicker() {
        var h = getTimePickerScrollIndex(timePickerHourList, 23);
        var m = getTimePickerScrollIndex(timePickerMinuteList, 59);
        departureTime.h = h;
        departureTime.m = m;
        var dayChanged = (pendingDayType !== selectedDayType);
        selectedDayType = pendingDayType;
        closeTimePickerModal();
        updateDepartureTriggerText();
        // 요일 또는 시간이 변경되었을 때 노선 다시 검색
        if (dayChanged || (routeOptionsWrap && routeOptionsWrap.classList.contains('show'))) {
          refreshLastShuttleResult();
        }
      }
      function refreshLastShuttleResult(opts) {
        opts = opts || {};
        if (!lastPlace || !lastShuttleType) return;
        if (lastShuttleType === 'depart') runDepartWithPlace(lastPlace, opts);
        else runArriveWithPlace(lastPlace, opts);
      }

      // ── 요일 선택 (통합 모달 내 칩) ─────────────────────────
      var DAY_TYPE_OPTIONS_BASE = [
        { value: 'weekday', label: '평일', shortLabel: '평일', desc: '월~금' },
        { value: 'monday', label: '월요일', shortLabel: '월', desc: '월요일에 배차 시간이 다른 경우' },
        { value: 'saturday', label: '토요일', shortLabel: '토', desc: '토요일' },
        { value: 'holiday', label: '휴일', shortLabel: '휴일', desc: '일요일/공휴일' },
        { value: 'familyday', label: 'D-day / 패밀리데이', shortLabel: 'D/F', desc: '매월 21일이 있는 주의 금요일' }
      ];
      var DAY_TYPE_OPTIONS = DAY_TYPE_OPTIONS_BASE.slice();
      var DAY_TYPE_OPTION_MAP = {};
      var DAY_TYPE_LABEL_MAP = {};
      var DAY_TYPE_SHORT_MAP = {};
      DAY_TYPE_OPTIONS_BASE.forEach(function(o) {
        DAY_TYPE_OPTION_MAP[o.value] = o;
        DAY_TYPE_LABEL_MAP[o.value] = o.label;
        DAY_TYPE_SHORT_MAP[o.value] = o.shortLabel;
      });

      // 모달 내에서만 임시 선택 상태를 유지 (확인 전)
      var pendingDayType = 'weekday';

      function buildDayTypeOptionsFromValues(dayTypeValues) {
        if (!Array.isArray(dayTypeValues)) return DAY_TYPE_OPTIONS_BASE.slice();
        var out = [];
        var seen = {};
        dayTypeValues.forEach(function(raw) {
          var value = String(raw || '').trim();
          if (!value || seen[value]) return;
          seen[value] = true;
          var known = DAY_TYPE_OPTION_MAP[value];
          if (known) {
            out.push(known);
            return;
          }
          DAY_TYPE_LABEL_MAP[value] = value;
          DAY_TYPE_SHORT_MAP[value] = value;
          out.push({ value: value, label: value, shortLabel: value, desc: '' });
        });
        return out;
      }

      function applyAvailableDayTypes(dayTypeValues) {
        DAY_TYPE_OPTIONS = buildDayTypeOptionsFromValues(dayTypeValues);
        if (!Array.isArray(dayTypeValues) && DAY_TYPE_OPTIONS.length === 0) {
          DAY_TYPE_OPTIONS = DAY_TYPE_OPTIONS_BASE.slice();
        }

        var hasSelected = DAY_TYPE_OPTIONS.some(function(opt) { return opt.value === selectedDayType; });
        if (!hasSelected) {
          selectedDayType = DAY_TYPE_OPTIONS.length > 0 ? DAY_TYPE_OPTIONS[0].value : 'weekday';
        }

        var hasPending = DAY_TYPE_OPTIONS.some(function(opt) { return opt.value === pendingDayType; });
        pendingDayType = hasPending ? pendingDayType : selectedDayType;
        updateDepartureTriggerText();
      }

      function isFamilyDay(date) {
        var y = date.getFullYear(), m = date.getMonth();
        var day21 = new Date(y, m, 21);
        var dow21 = day21.getDay(); // 0=일 ... 6=토
        var mondayOffset = (dow21 + 6) % 7;
        var mondayDate = 21 - mondayOffset;
        var friday = new Date(y, m, mondayDate + 4);
        return date.getDate() === friday.getDate() && date.getMonth() === friday.getMonth();
      }

      function detectDayType() {
        var now = new Date();
        var dow = now.getDay();
        if (dow === 0) return 'holiday';
        if (dow === 6) return 'saturday';
        if (dow === 1) return 'monday';
        if (dow === 5 && isFamilyDay(now)) return 'familyday';
        return 'weekday';
      }

      function buildDayTypeWheel() {
        if (!dayTypeList) return;
        dayTypeList.innerHTML = '';
        var padTop = document.createElement('div');
        padTop.className = 'time-picker-pad';
        dayTypeList.appendChild(padTop);
        DAY_TYPE_OPTIONS.forEach(function(opt, i) {
          var el = document.createElement('div');
          el.className = 'time-picker-item';
          el.setAttribute('data-value', opt.value);
          el.setAttribute('data-index', i);
          var labelSpan = document.createElement('span');
          labelSpan.className = 'day-type-label';
          labelSpan.textContent = opt.label;
          var descSpan = document.createElement('span');
          descSpan.className = 'day-type-desc';
          descSpan.textContent = opt.desc;
          el.appendChild(labelSpan);
          el.appendChild(descSpan);
          dayTypeList.appendChild(el);
        });
        var padBottom = document.createElement('div');
        padBottom.className = 'time-picker-pad';
        dayTypeList.appendChild(padBottom);
      }
      function getDayTypeScrollIndex() {
        if (!dayTypeList || DAY_TYPE_OPTIONS.length === 0) return 0;
        var index = Math.round(dayTypeList.scrollTop / DAY_TYPE_ITEM_HEIGHT);
        return Math.max(0, Math.min(DAY_TYPE_OPTIONS.length - 1, index));
      }
      function updateDayTypeSelectedClasses() {
        if (DAY_TYPE_OPTIONS.length === 0) {
          pendingDayType = selectedDayType;
          return;
        }
        var idx = getDayTypeScrollIndex();
        if (dayTypeList) {
          dayTypeList.querySelectorAll('.time-picker-item').forEach(function(item, i) {
            item.classList.toggle('selected', i === idx);
          });
        }
        pendingDayType = DAY_TYPE_OPTIONS[idx] ? DAY_TYPE_OPTIONS[idx].value : selectedDayType;
      }
      function scrollDayTypeToValue(value) {
        if (!dayTypeList || DAY_TYPE_OPTIONS.length === 0) return;
        var idx = 0;
        DAY_TYPE_OPTIONS.forEach(function(opt, i) { if (opt.value === value) idx = i; });
        dayTypeList.scrollTop = idx * DAY_TYPE_ITEM_HEIGHT;
      }

      // 초기화: 요일 기본값은 평일
      selectedDayType = 'weekday';

      function updateSiteTriggerText() {
        if (!siteSelectTrigger || !siteSelect) return;
        var opt = siteSelect.options[siteSelect.selectedIndex];
        var siteTriggerTextEl = siteSelectTrigger.querySelector('.site-trigger-text');
        if (siteTriggerTextEl) siteTriggerTextEl.textContent = opt ? opt.text : '';
      }
      function setSiteSelectorEnabled(enabled) {
        if (!siteSelectTrigger) return;
        siteSelectTrigger.disabled = !enabled;
        siteSelectTrigger.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      }
      function openSitePickerModal() {
        if (!sitePickerBackdrop || !sitePickerModal || !sitePickerList) return;
        if (siteSelectTrigger && siteSelectTrigger.disabled) return;
        var trigger = siteSelectTrigger;
        if (isMobile()) {
          sitePickerModal.style.top = '';
          sitePickerModal.style.left = '';
          sitePickerModal.style.right = '';
          sitePickerModal.style.bottom = '0';
        } else {
          if (trigger) {
            var rect = trigger.getBoundingClientRect();
            sitePickerModal.style.top = (rect.bottom + 4) + 'px';
            sitePickerModal.style.right = (window.innerWidth - rect.right) + 'px';
            sitePickerModal.style.left = 'auto';
            sitePickerModal.style.bottom = 'auto';
          }
        }
        sitePickerList.innerHTML = '';
        var options = siteSelect ? siteSelect.options : [];
        var selectedValue = siteSelect ? siteSelect.value : '';
        for (var i = 0; i < options.length; i++) {
          var opt = options[i];
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'site-picker-item' + (opt.value === selectedValue ? ' selected' : '');
          btn.textContent = opt.text;
          btn.setAttribute('data-value', opt.value);
          btn.setAttribute('role', 'option');
          btn.setAttribute('aria-selected', opt.value === selectedValue ? 'true' : 'false');
          btn.addEventListener('click', function() {
            var val = this.getAttribute('data-value');
            if (siteSelect && val !== siteSelect.value) {
              siteSelect.value = val;
              selectedSiteId = val;
              siteSelect.dispatchEvent(new Event('change'));
            }
            updateSiteTriggerText();
            closeSitePickerModal();
          });
          sitePickerList.appendChild(btn);
        }
        sitePickerBackdrop.classList.add('show');
        sitePickerModal.classList.add('show');
        if (trigger) trigger.setAttribute('aria-expanded', 'true');
      }
      function closeSitePickerModal() {
        if (sitePickerBackdrop) sitePickerBackdrop.classList.remove('show');
        if (sitePickerModal) sitePickerModal.classList.remove('show');
        if (siteSelectTrigger) siteSelectTrigger.setAttribute('aria-expanded', 'false');
      }

      function setIssueFeedback(type, message) {
        if (!issueFeedback) return;
        if (!message) {
          issueFeedback.className = 'issue-feedback';
          issueFeedback.textContent = '';
          return;
        }
        issueFeedback.className = 'issue-feedback show ' + (type || 'info');
        issueFeedback.textContent = message;
      }

      function formatIssueDate(iso) {
        if (!iso) return '-';
        var d = new Date(iso);
        if (isNaN(d.getTime())) return '-';
        return d.getFullYear() + '.' + pad2(d.getMonth() + 1) + '.' + pad2(d.getDate()) + ' ' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
      }

      function setIssueView(view) {
        issueCurrentView = view;
        if (issueListView) issueListView.classList.toggle('show', view === 'list');
        if (issueDetailView) issueDetailView.classList.toggle('show', view === 'detail');
        if (issueFormView) issueFormView.classList.toggle('show', view === 'form');
        if (issueComposeBtn) issueComposeBtn.style.display = (view === 'list') ? '' : 'none';
      }

      function renderIssuePagination(pagination) {
        var page = pagination && pagination.page ? pagination.page : 1;
        var hasPrev = !!(pagination && pagination.has_prev);
        var hasNext = !!(pagination && pagination.has_next);
        var totalCount = pagination ? pagination.total_count : null;
        issueCurrentPage = page;
        issueHasNextPage = hasNext;
        if (issuePrevPageBtn) issuePrevPageBtn.disabled = !hasPrev;
        if (issueNextPageBtn) issueNextPageBtn.disabled = !hasNext;
        if (issuePageInfo) {
          if (typeof totalCount === 'number' && totalCount >= 0) {
            var totalPages = Math.max(1, Math.ceil(totalCount / ISSUE_PAGE_SIZE));
            issuePageInfo.textContent = page + ' / ' + totalPages + '페이지';
          } else {
            issuePageInfo.textContent = page + '페이지';
          }
        }
      }

      function renderIssueList(issues) {
        if (!issueListEl) return;
        issueListEl.innerHTML = '';
        if (!issues || issues.length === 0) {
          issueListEl.innerHTML = '<div class="issue-empty">등록된 이슈가 없습니다.</div>';
          return;
        }

        issues.forEach(function(issue) {
          var isNotice = !!issue.is_notice;
          var status = (issue.state || 'open').toLowerCase();
          var statusClass = isNotice ? 'notice' : (status === 'closed' ? 'closed' : 'open');
          var statusLabel = isNotice ? '공지' : (status === 'closed' ? 'CLOSED' : 'OPEN');
          var issueNumberHtml = isNotice ? '' : ('<span class="issue-card-number">#' + issue.number + '</span>');
          var bodyPreview = (issue.body || '').trim();
          if (bodyPreview.length > 180) bodyPreview = bodyPreview.slice(0, 180) + '...';
          var card = document.createElement('article');
          card.className = 'issue-card';
          card.innerHTML =
            '<div class="issue-card-top">' +
              '<div><span class="issue-status-badge ' + statusClass + '">' + statusLabel + '</span>' +
              issueNumberHtml + '</div>' +
              '<div>' + formatIssueDate(issue.created_at) + '</div>' +
            '</div>' +
            '<h3 class="issue-card-title">' + escapeHtml(issue.title || '') + '</h3>' +
            '<div class="issue-card-body">' + (bodyPreview ? escapeHtml(bodyPreview).replace(/\n/g, '<br>') : '-') + '</div>' +
            '<div class="issue-card-footer">' +
              '<button type="button" class="issue-detail-btn" data-number="' + issue.number + '">내용/댓글 보기</button>' +
              '<div>댓글 ' + (issue.comments || 0) + '개</div>' +
            '</div>';
          issueListEl.appendChild(card);
        });

        issueListEl.querySelectorAll('.issue-detail-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var no = this.getAttribute('data-number');
            if (!no) return;
            openIssueDetail(parseInt(no, 10));
          });
        });
      }

      function loadIssues(page, preserveFeedback) {
        if (!issueListEl) return;
        var targetPage = page || 1;
        if (!preserveFeedback) setIssueFeedback('info', '이슈 목록을 불러오는 중입니다...');
        issueListEl.innerHTML = '<div class="issue-empty">불러오는 중...</div>';

        var url = API_BASE + '/api/issues?state=' + encodeURIComponent(issueCurrentState) +
          '&page=' + targetPage +
          '&per_page=' + ISSUE_PAGE_SIZE;

        fetch(url)
          .then(function(r) {
            return r.json().catch(function() { return {}; }).then(function(data) {
              return { ok: r.ok, data: data };
            });
          })
          .then(function(result) {
            if (!result.ok) {
              throw new Error(result.data.error || '이슈 목록 조회에 실패했습니다.');
            }
            var data = result.data || {};
            var issues = Array.isArray(data.issues) ? data.issues : [];
            var pagination = data.pagination || {};
            renderIssueList(issues);
            renderIssuePagination(pagination);
            if (!preserveFeedback) setIssueFeedback('', '');
          })
          .catch(function(err) {
            issueListEl.innerHTML = '<div class="issue-empty">목록을 불러오지 못했습니다.</div>';
            renderIssuePagination({ page: targetPage, has_prev: targetPage > 1, has_next: false });
            setIssueFeedback('error', err.message || '이슈 목록 조회에 실패했습니다.');
          });
      }

      function openIssueDetail(issueNumber) {
        if (!issueDetailContent || !issueNumber) return;
        setIssueView('detail');
        issueDetailContent.innerHTML = '<div class="issue-empty">상세 정보를 불러오는 중...</div>';

        fetch(API_BASE + '/api/issues/' + issueNumber)
          .then(function(r) {
            return r.json().catch(function() { return {}; }).then(function(data) {
              return { ok: r.ok, data: data };
            });
          })
          .then(function(result) {
            if (!result.ok) {
              throw new Error(result.data.error || '이슈 상세 조회에 실패했습니다.');
            }
            var payload = result.data || {};
            var issue = payload.issue || {};
            var comments = payload.comments || [];
            var isNotice = !!issue.is_notice;
            var status = (issue.state || 'open').toLowerCase();
            var statusClass = isNotice ? 'notice' : (status === 'closed' ? 'closed' : 'open');
            var statusLabel = isNotice ? '공지' : (status === 'closed' ? 'CLOSED' : 'OPEN');
            var issueNumberHtml = isNotice ? '' : ('<span class="issue-card-number">#' + issue.number + '</span>');
            var commentsHtml = '';
            if (!comments.length) {
              commentsHtml = '<div class="issue-empty">아직 댓글이 없습니다.</div>';
            } else {
              commentsHtml = comments.map(function(comment) {
                var rawUser = String(comment.user || 'unknown');
                var isBotAuthor = !!comment.is_bot || rawUser.trim().toLowerCase().endsWith('[bot]');
                var metaText = isBotAuthor
                  ? formatIssueDate(comment.created_at)
                  : ('<strong>' + escapeHtml(rawUser) + '</strong>' + ' · ' + formatIssueDate(comment.created_at));
                return (
                  '<div class="issue-comment-item">' +
                    '<div class="issue-comment-meta">' +
                      metaText +
                    '</div>' +
                    '<div class="issue-comment-body">' + escapeHtml(comment.body || '').replace(/\n/g, '<br>') + '</div>' +
                  '</div>'
                );
              }).join('');
            }

            issueDetailContent.innerHTML =
              '<div class="issue-card-top">' +
                '<div><span class="issue-status-badge ' + statusClass + '">' + statusLabel + '</span>' + issueNumberHtml + '</div>' +
                '<div>' + formatIssueDate(issue.created_at) + '</div>' +
              '</div>' +
              '<h3 class="issue-detail-title">' + escapeHtml(issue.title || '') + '</h3>' +
              '<div class="issue-detail-body">' + (issue.body ? escapeHtml(issue.body).replace(/\n/g, '<br>') : '-') + '</div>' +
              '<div class="issue-comments-title">댓글 ' + comments.length + '개</div>' +
              '<div class="issue-comments-list">' + commentsHtml + '</div>' +
              '<div class="issue-comment-compose">' +
                '<div class="issue-comment-compose-title">댓글 작성</div>' +
                '<textarea id="issueDetailCommentBody" placeholder="댓글을 입력해 주세요."></textarea>' +
                '<div class="issue-comment-compose-actions">' +
                  '<button type="button" class="issue-form-btn primary" id="issueDetailCommentSubmit">댓글 등록</button>' +
                '</div>' +
              '</div>';

            var detailCommentBody = document.getElementById('issueDetailCommentBody');
            var detailCommentSubmit = document.getElementById('issueDetailCommentSubmit');
            if (detailCommentBody && detailCommentSubmit) {
              detailCommentSubmit.addEventListener('click', function() {
                var bodyText = detailCommentBody.value.trim();
                if (!bodyText) {
                  setIssueFeedback('error', '댓글 내용을 입력해 주세요.');
                  detailCommentBody.focus();
                  return;
                }

                detailCommentSubmit.disabled = true;
                setIssueFeedback('info', '댓글을 등록하는 중입니다...');

                fetch(API_BASE + '/api/issues/' + issue.number + '/comments', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ body: bodyText })
                })
                  .then(function(r) {
                    return r.json().catch(function() { return {}; }).then(function(data) {
                      return { ok: r.ok, data: data };
                    });
                  })
                  .then(function(postResult) {
                    if (!postResult.ok) {
                      throw new Error(postResult.data.error || '댓글 등록에 실패했습니다.');
                    }
                    setIssueFeedback('success', '댓글이 등록되었습니다.');
                    openIssueDetail(issue.number);
                  })
                  .catch(function(postErr) {
                    setIssueFeedback('error', postErr.message || '댓글 등록에 실패했습니다.');
                  })
                  .finally(function() {
                    if (detailCommentSubmit && detailCommentSubmit.isConnected) {
                      detailCommentSubmit.disabled = false;
                    }
                  });
              });
            }
          })
          .catch(function(err) {
            issueDetailContent.innerHTML = '<div class="issue-empty">' + escapeHtml(err.message || '상세 조회에 실패했습니다.') + '</div>';
          });
      }

      function openIssueCreateView() {
        setIssueView('form');
        if (issueTitleInput) issueTitleInput.focus();
      }

      function backToIssueList() {
        setIssueView('list');
        setIssueFeedback('', '');
      }

      function openIssueModal() {
        if (!issueModalBackdrop || !issueModal) return;
        issueCurrentPage = 1;
        issueCurrentState = issueStateFilter ? issueStateFilter.value : 'all';
        setIssueView('list');
        issueModalBackdrop.classList.add('show');
        issueModal.classList.add('show');
        loadIssues(1, false);
      }

      function closeIssueModal() {
        if (issueModalBackdrop) issueModalBackdrop.classList.remove('show');
        if (issueModal) issueModal.classList.remove('show');
        setIssueFeedback('', '');
      }

      function submitIssueForm(e) {
        e.preventDefault();
        if (!issueTitleInput || !issueBodyInput) return;
        var title = issueTitleInput.value.trim();
        var body = issueBodyInput.value.trim();
        var nickname = issueNicknameInput ? issueNicknameInput.value.trim() : '';
        var issueTitle = nickname ? (title + ' - ' + nickname) : title;
        if (!title) {
          setIssueFeedback('error', '제목을 입력해 주세요.');
          return;
        }
        if (!body) {
          setIssueFeedback('error', '내용을 입력해 주세요.');
          return;
        }

        if (issueFormSubmitBtn) issueFormSubmitBtn.disabled = true;
        setIssueFeedback('info', '건의를 등록하는 중입니다...');

        fetch(API_BASE + '/api/issues', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: issueTitle,
            body: body
          })
        })
          .then(function(r) {
            return r.json().catch(function() { return {}; }).then(function(data) {
              return { ok: r.ok, data: data };
            });
          })
          .then(function(result) {
            if (!result.ok) {
              throw new Error(result.data.error || '건의 등록에 실패했습니다.');
            }
            if (issueCreateForm) issueCreateForm.reset();
            setIssueView('list');
            setIssueFeedback('success', '건의가 등록되었습니다.');
            issueCurrentPage = 1;
            loadIssues(1, true);
          })
          .catch(function(err) {
            setIssueFeedback('error', err.message || '건의 등록에 실패했습니다.');
          })
          .finally(function() {
            if (issueFormSubmitBtn) issueFormSubmitBtn.disabled = false;
          });
      }

      function updatePinScale() {
        if (!map || !mapContainer) return;
        var level = map.getLevel();
        var scale = Math.max(0.75, Math.min(1.5, 1.5 - level * 0.05));
        mapContainer.style.setProperty('--pin-scale', String(scale));
      }

      function initMap() {
        var center = new kakao.maps.LatLng(37.5665, 126.978);
        var options = { center: center, level: 5 };
        map = new kakao.maps.Map(mapContainer, options);
        updatePinScale();
        kakao.maps.event.addListener(map, 'dragstart', function() {
          closeBubble();
        });
        kakao.maps.event.addListener(map, 'zoom_changed', function() {
          closeBubble();
          updatePinScale();
        });
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
          var lat = mouseEvent.latLng.getLat();
          var lng = mouseEvent.latLng.getLng();
          setTimeout(function() {
            if (mapClickIgnore) {
              mapClickIgnore = false;
              return;
            }
            if (bubbleOverlay) {
              closeBubble();
              deselectPlace();
              setMapDimmed(false);
              return;
            }
            if (bubbleClosedByOutsideAt && (Date.now() - bubbleClosedByOutsideAt) < 150) {
              bubbleClosedByOutsideAt = 0;
              return;
            }
            showBubbleAtPosition(lat, lng);
          }, 0);
        });
        if (isMobile()) {
          mapContainer.addEventListener('touchstart', onMapTouchStart, { passive: true });
          mapContainer.addEventListener('touchend', onMapTouchEnd, { passive: false });
        }
        document.addEventListener('click', closeBubbleIfOutside);
        document.addEventListener('touchend', closeBubbleIfOutside, { passive: true });
      }

      function onMapTouchStart(e) {
        if (!e.touches || e.touches.length === 0) return;
        mapTouchStart = {
          x: e.touches[0].clientX,
          y: e.touches[0].clientY,
          time: Date.now()
        };
      }

      function onMapTouchEnd(e) {
        if (!mapTouchStart || !e.changedTouches || e.changedTouches.length === 0) return;
        var t = e.changedTouches[0];
        var duration = Date.now() - mapTouchStart.time;
        var dx = t.clientX - mapTouchStart.x;
        var dy = t.clientY - mapTouchStart.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        mapTouchStart = null;
        if (duration > 300 || dist > 15) return;
        // 핀 마커 위를 탭한 경우 — 핀의 click 이벤트에 위임
        var touchTarget = document.elementFromPoint(t.clientX, t.clientY);
        if (touchTarget && touchTarget.closest('.pin-marker')) return;
        var rect = mapContainer.getBoundingClientRect();
        var x = t.clientX - rect.left;
        var y = t.clientY - rect.top;
        var proj = map.getProjection();
        if (!proj || typeof proj.coordsFromContainerPoint !== 'function') return;
        var pt = new kakao.maps.Point(x, y);
        var latLng = proj.coordsFromContainerPoint(pt);
        if (latLng && typeof latLng.getLat === 'function' && typeof latLng.getLng === 'function') {
          e.preventDefault();
          mapClickIgnore = true;
          if (bubbleOverlay) {
            closeBubble();
            deselectPlace();
            setMapDimmed(false);
            return;
          }
          showBubbleAtPosition(latLng.getLat(), latLng.getLng());
        }
      }

      function refreshDayTypeOptionsForSite(siteId) {
        var requestId = ++dayTypeRequestSerial;
        return fetch(API_BASE + '/api/shuttle/day-types?site_id=' + encodeURIComponent(siteId))
          .then(function(r) {
            return r.json().catch(function() { return {}; }).then(function(data) {
              return { ok: r.ok, data: data };
            });
          })
          .then(function(result) {
            if (requestId !== dayTypeRequestSerial) return false;
            if (!result.ok) {
              throw new Error(result.data.error || '요일 목록 조회에 실패했습니다.');
            }
            var dayTypes = Array.isArray(result.data.day_types) ? result.data.day_types : [];
            applyAvailableDayTypes(dayTypes);
            return true;
          })
          .catch(function() {
            if (requestId !== dayTypeRequestSerial) return false;
            applyAvailableDayTypes(null);
            return true;
          });
      }

      function loadSites() {
        setSiteSelectorEnabled(false);
        fetch(API_BASE + '/api/sites')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var list = data.sites || [];
            dbUpdatedAt = data.db_updated_at || '';
            siteSelect.innerHTML = '';
            if (list.length === 0) {
              siteSelect.appendChild(new Option('삼성전자(수원)', '0000013'));
            } else {
              list.forEach(function(site) {
                siteSelect.appendChild(new Option(site.site_name, String(site.site_id)));
              });
            }
            if (siteSelect.querySelector('option[value="0000013"]')) {
              siteSelect.value = '0000013';
            }
            selectedSiteId = siteSelect.value;
            updateSiteTriggerText();
            return refreshDayTypeOptionsForSite(selectedSiteId);
          })
          .catch(function() {
            siteSelect.innerHTML = '';
            siteSelect.appendChild(new Option('삼성전자(기흥/화성)', '0000011'));
            siteSelect.value = '0000011';
            selectedSiteId = '0000011';
            updateSiteTriggerText();
            return refreshDayTypeOptionsForSite(selectedSiteId);
          })
          .finally(function() {
            setSiteSelectorEnabled(true);
          });
      }

      siteSelect.addEventListener('change', function() {
        selectedSiteId = siteSelect.value;
        refreshDayTypeOptionsForSite(selectedSiteId).then(function(applied) {
          if (applied !== false) refreshLastShuttleResult();
        });
      });
      if (siteSelectTrigger) siteSelectTrigger.addEventListener('click', openSitePickerModal);
      if (sitePickerBackdrop) sitePickerBackdrop.addEventListener('click', closeSitePickerModal);
      if (sitePickerModal) sitePickerModal.addEventListener('click', function(e) { e.stopPropagation(); });
      updateSiteTriggerText();
      setSiteSelectorEnabled(false);

      if (routeTopEndpointTrigger) {
        routeTopEndpointTrigger.addEventListener('click', function(e) {
          e.preventDefault();
          openEndpointPickerModal();
        });
      }
      if (routeBottomEndpointTrigger) {
        routeBottomEndpointTrigger.addEventListener('click', function(e) {
          e.preventDefault();
          openEndpointPickerModal();
        });
      }
      if (endpointPickerBackdrop) endpointPickerBackdrop.addEventListener('click', closeEndpointPickerModal);
      if (endpointPickerModal) endpointPickerModal.addEventListener('click', function(e) { e.stopPropagation(); });
      if (endpointPickerConfirmBtn) {
        endpointPickerConfirmBtn.addEventListener('click', function(e) {
          e.preventDefault();
          closeEndpointPickerModal();
        });
      }
      if (endpointPickerSearchInput) {
        endpointPickerSearchInput.addEventListener('input', function() {
          var keyword = endpointPickerSearchInput.value || '';
          if (endpointSearchTimer) clearTimeout(endpointSearchTimer);
          endpointSearchTimer = setTimeout(function() {
            endpointSearchTimer = null;
            applyEndpointRouteKeywordSearch(keyword);
          }, 180);
        });
      }
      if (routeHeaderBackBtn) routeHeaderBackBtn.addEventListener('click', goBackFromRouteOptions);

      if (issueModalTrigger) issueModalTrigger.addEventListener('click', openIssueModal);
      if (routeIssueModalTrigger) routeIssueModalTrigger.addEventListener('click', openIssueModal);
      if (issueModalCloseBtn) issueModalCloseBtn.addEventListener('click', closeIssueModal);
      if (issueModalBackdrop) issueModalBackdrop.addEventListener('click', closeIssueModal);
      if (issueModal) issueModal.addEventListener('click', function(e) { e.stopPropagation(); });
      if (issueComposeBtn) issueComposeBtn.addEventListener('click', openIssueCreateView);
      if (issueDetailBackBtn) issueDetailBackBtn.addEventListener('click', backToIssueList);
      if (issueFormCancelBtn) issueFormCancelBtn.addEventListener('click', function() {
        setIssueView('list');
        setIssueFeedback('', '');
      });
      if (issueCreateForm) issueCreateForm.addEventListener('submit', submitIssueForm);
      if (issueStateFilter) {
        issueStateFilter.addEventListener('change', function() {
          issueCurrentState = issueStateFilter.value;
          issueCurrentPage = 1;
          loadIssues(1, false);
        });
      }
      if (issuePrevPageBtn) {
        issuePrevPageBtn.addEventListener('click', function() {
          if (issueCurrentPage <= 1) return;
          loadIssues(issueCurrentPage - 1, false);
        });
      }
      if (issueNextPageBtn) {
        issueNextPageBtn.addEventListener('click', function() {
          if (!issueHasNextPage) return;
          loadIssues(issueCurrentPage + 1, false);
        });
      }
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Escape') return;
        if (issueModal && issueModal.classList.contains('show')) closeIssueModal();
        closeEndpointPickerModal();
        closeMaxDistancePopover();
      });

      function clearSearchOverlays() {
        overlays.forEach(function(o) { o.setMap(null); });
        overlays = [];
        markerElements = [];
        hideHoverMarker();
      }

      function clearShuttleOverlays() {
        clearTimeout(shuttleLabelAdjustTimer);
        shuttleLabelAdjustTimer = null;
        if (shuttleLine) {
          shuttleLine.setMap(null);
          shuttleLine = null;
        }
        shuttlePointOverlays.forEach(function(o) { o.setMap(null); });
        shuttlePointOverlays = [];
        shuttlePointContents = [];
        shuttlePositions = [];
      }

      function addMarker(lat, lng, index) {
        var pos = new kakao.maps.LatLng(lat, lng);
        var el = document.createElement('div');
        el.className = 'pin-marker';
        el.setAttribute('data-index', index);
        el.addEventListener('mouseenter', function() {
          if (selectedPlaceIndex >= 0) return;
          onMarkerHover(index, true);
          if (!isMobile()) showBubble(index);
        });
        el.addEventListener('mouseleave', function() {
          if (selectedPlaceIndex >= 0) return;
          onMarkerHover(index, false);
          if (!isMobile()) closeBubble();
        });
        el.addEventListener('click', function(e) {
          e.stopPropagation();
          mapClickIgnore = true;
          if (isMobile()) {
            closeBubble();
            selectPlace(index);
            setMapDimmed(true, index);
            // 시트를 내리되 adjustMapForSheet는 건너뜀 (panTo를 보존)
            resultsPanel.classList.remove('sheet-peek', 'sheet-half', 'sheet-full');
            resultsPanel.classList.add('sheet-peek');
            var place = places[index];
            if (place) panTo(parseFloat(place.y), parseFloat(place.x));
            setTimeout(function() { showBubble(index); }, 60);
          } else {
            selectPlace(index);
            setMapDimmed(true, index);
            showBubble(index);
          }
        });
        var overlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: el,
          yAnchor: 1
        });
        overlay.setMap(map);
        overlays.push(overlay);
        markerElements.push(el);
        return pos;
      }

      function onMarkerHover(index, enter) {
        if (selectedPlaceIndex >= 0) return;
        if (enter) {
          markerElements.forEach(function(m, i) {
            m.classList.toggle('hover', i === index);
          });
          var cards = resultsList.querySelectorAll('.result-card');
          cards.forEach(function(c, i) {
            c.classList.toggle('highlight', i === index);
          });
          var card = cards[index];
          if (card) card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          markerElements.forEach(function(m) { m.classList.remove('hover'); });
          resultsList.querySelectorAll('.result-card').forEach(function(c) { c.classList.remove('highlight'); });
        }
      }

      function onListCardHover(index, enter) {
        if (enter && places[index] && map) {
          setMapDimmed(true, index);
          if (overlays.length === 0) showHoverMarker(index);
        } else {
          setMapDimmed(false);
          hideHoverMarker();
        }
      }

      function setMapDimmed(dimmed, highlightIndex) {
        if (dimmed) {
          markerElements.forEach(function(m, i) {
            m.style.opacity = (i === highlightIndex) ? '1' : '0.35';
            m.classList.toggle('hover', i === highlightIndex);
          });
          shuttlePointContents.forEach(function(el) {
            if (el && el.style) el.style.opacity = '0.35';
          });
          if (shuttleLine) shuttleLine.setOptions({ strokeOpacity: 0.25 });
          shuttleMessage.classList.add('dimmed');
        } else {
          markerElements.forEach(function(m) {
            m.style.opacity = '';
            m.classList.remove('hover');
          });
          shuttlePointContents.forEach(function(el) {
            if (el && el.style) el.style.opacity = '';
          });
          if (shuttleLine) shuttleLine.setOptions({ strokeOpacity: 0.9 });
          shuttleMessage.classList.remove('dimmed');
        }
      }

      function showHoverMarker(index) {
        hideHoverMarker();
        var place = places[index];
        if (!place) return;
        var lat = parseFloat(place.y);
        var lng = parseFloat(place.x);
        var el = document.createElement('div');
        el.className = 'pin-marker hover';
        var overlay = new kakao.maps.CustomOverlay({
          position: new kakao.maps.LatLng(lat, lng),
          content: el,
          yAnchor: 1
        });
        overlay.setMap(map);
        hoverPlaceOverlay = overlay;
      }

      function hideHoverMarker() {
        if (hoverPlaceOverlay) {
          hoverPlaceOverlay.setMap(null);
          hoverPlaceOverlay = null;
        }
      }

      function closeBubble() {
        if (bubbleOverlay) {
          if (bubbleOverlay.parentNode) bubbleOverlay.parentNode.removeChild(bubbleOverlay);
          bubbleOverlay = null;
        }
      }

      function closeBubbleIfOutside(e) {
        if (!bubbleOverlay) return;
        if (Date.now() - bubbleOpenedAt < 200) return;
        if (bubbleOverlay.contains(e.target)) return;
        bubbleClosedByOutsideAt = Date.now();
        closeBubble();
        deselectPlace();
        setMapDimmed(false);
      }

      function showBubble(index) {
        closeBubble();
        var place = places[index];
        if (!place) return;
        var lat = parseFloat(place.y);
        var lng = parseFloat(place.x);
        showBubbleWithPlace(place, lat, lng, true);
      }

      function showBubbleAtPosition(lat, lng) {
        if (searchInput && document.activeElement === searchInput) {
          searchInput.blur();
        }
        closeBubble();
        var place = {
          place_name: '선택한 위치',
          address_name: '',
          y: lat,
          x: lng
        };
        showBubbleWithPlace(place, lat, lng, false);
      }

      function showBubbleWithPlace(place, lat, lng, hasPin) {
        closeBubble();
        var pos = new kakao.maps.LatLng(lat, lng);
        var proj = map.getProjection();
        var clickX, clickY;
        if (proj && typeof proj.containerPointFromCoords === 'function') {
          var clickPt = proj.containerPointFromCoords(pos);
          clickX = clickPt.x;
          clickY = clickPt.y;
        } else {
          clickX = mapContainer.clientWidth / 2;
          clickY = mapContainer.clientHeight / 2;
        }
        var mapW = mapContainer.clientWidth;
        var mapH = mapContainer.clientHeight;

        // 박스 생성
        var box = document.createElement('div');
        box.className = 'bubble-box';
        box.innerHTML =
          '<div class="bubble-header">' +
          '<span class="bubble-name">' + escapeHtml(place.place_name || '') + '</span>' +
          '<button type="button" class="bubble-close" title="닫기" aria-label="닫기">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
          '</button></div>' +
          '<div class="bubble-addr">' + escapeHtml(place.address_name || '') + '</div>' +
          '<div class="bubble-actions">' +
          '<button type="button" class="btn-depart">출발</button>' +
          '<button type="button" class="btn-arrive">도착</button>' +
          '</div>';

        // 컨테이너 생성 및 임시 추가 (크기 측정)
        var container = document.createElement('div');
        container.className = 'bubble-container';
        container.appendChild(box);
        mapContainer.appendChild(container);

        var boxW = box.offsetWidth;
        var boxH = box.offsetHeight;

        // 핀 상단 위치 계산 (꼬리 끝이 핀 바로 위에 위치, 핀 없으면 클릭 지점 그대로)
        var pinTopOffset = 0;
        if (hasPin) {
          var pinScale = parseFloat(mapContainer.style.getPropertyValue('--pin-scale')) || 1;
          pinTopOffset = Math.round(34 * pinScale);
        }
        var tailTipX = clickX;
        var tailTipY = clickY - pinTopOffset;

        // 뷰포트 내 최적 위치 계산
        var pad = 8;
        var tailLen = 10;
        var boxLeft = tailTipX - boxW / 2;
        var boxTop = tailTipY - boxH - tailLen;

        // 수평 클램핑
        if (boxLeft < pad) boxLeft = pad;
        if (boxLeft + boxW > mapW - pad) boxLeft = mapW - pad - boxW;

        // 상단 벗어나면 아래로 (핀 아래에 표시)
        if (boxTop < pad) {
          tailTipY = clickY + tailLen;
          boxTop = tailTipY + tailLen;
        }

        // 하단 벗어나면 클램핑
        if (boxTop + boxH > mapH - pad) {
          boxTop = mapH - pad - boxH;
        }

        box.style.left = Math.round(boxLeft) + 'px';
        box.style.top = Math.round(boxTop) + 'px';

        // SVG 꼬리 생성
        var boxRect = { left: boxLeft, top: boxTop, width: boxW, height: boxH };
        var tailBase = getBubbleTailBase(boxRect, tailTipX, tailTipY, 14);
        if (tailBase) {
          var svgNS = 'http://www.w3.org/2000/svg';
          var svg = document.createElementNS(svgNS, 'svg');
          svg.setAttribute('class', 'bubble-tail-svg');
          var poly = document.createElementNS(svgNS, 'polygon');
          poly.setAttribute('points',
            tailBase.p1.x + ',' + tailBase.p1.y + ' ' +
            tailTipX + ',' + tailTipY + ' ' +
            tailBase.p2.x + ',' + tailBase.p2.y
          );
          poly.setAttribute('fill', '#fff');
          svg.appendChild(poly);
          container.insertBefore(svg, box);
        }

        // 이벤트 핸들러
        function dismissBubble() {
          closeBubble();
          deselectPlace();
          setMapDimmed(false);
        }
        function closeBubbleIfNotButtons(e) {
          e.stopPropagation();
          if (e.target.closest('.bubble-actions button')) return;
          e.preventDefault();
          dismissBubble();
        }
        box.addEventListener('click', closeBubbleIfNotButtons);
        box.addEventListener('touchend', closeBubbleIfNotButtons, { passive: false });
        box.querySelector('.bubble-close').addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          dismissBubble();
        });
        box.querySelector('.bubble-close').addEventListener('touchend', function(e) {
          e.stopPropagation();
          e.preventDefault();
          dismissBubble();
        });
        box.querySelector('.btn-depart').addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          closeBubble();
          runDepartWithPlace(place);
        });
        box.querySelector('.btn-arrive').addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          closeBubble();
          runArriveWithPlace(place);
        });

        bubbleOverlay = container;
        bubbleOpenedAt = Date.now();
      }

      function getBubbleTailBase(boxRect, tipX, tipY, baseWidth) {
        var cx = boxRect.left + boxRect.width / 2;
        var cy = boxRect.top + boxRect.height / 2;
        var dx = tipX - cx;
        var dy = tipY - cy;
        var hw = boxRect.width / 2;
        var hh = boxRect.height / 2;
        var halfBase = baseWidth / 2;

        // 클릭 지점이 박스 내부이면 꼬리 불필요
        if (Math.abs(dx) <= hw + 4 && Math.abs(dy) <= hh + 4) return null;

        var scaleX = Math.abs(dx) > 0.001 ? hw / Math.abs(dx) : 99999;
        var scaleY = Math.abs(dy) > 0.001 ? hh / Math.abs(dy) : 99999;

        if (scaleX < scaleY) {
          // 좌우 변에서 꼬리 시작
          var edgeX = dx > 0 ? boxRect.left + boxRect.width : boxRect.left;
          var edgeY = cy + dy * scaleX;
          edgeY = Math.max(boxRect.top + halfBase + 8, Math.min(boxRect.top + boxRect.height - halfBase - 8, edgeY));
          var inset = dx > 0 ? -2 : 2;
          return {
            p1: { x: edgeX + inset, y: edgeY - halfBase },
            p2: { x: edgeX + inset, y: edgeY + halfBase }
          };
        } else {
          // 상하 변에서 꼬리 시작
          var edgeY2 = dy > 0 ? boxRect.top + boxRect.height : boxRect.top;
          var edgeX2 = cx + dx * scaleY;
          edgeX2 = Math.max(boxRect.left + halfBase + 8, Math.min(boxRect.left + boxRect.width - halfBase - 8, edgeX2));
          var inset2 = dy > 0 ? -2 : 2;
          return {
            p1: { x: edgeX2 - halfBase, y: edgeY2 + inset2 },
            p2: { x: edgeX2 + halfBase, y: edgeY2 + inset2 }
          };
        }
      }

      function selectPlace(index) {
        selectedPlaceIndex = index;
        resultsList.querySelectorAll('.result-card').forEach(function(c, i) {
          c.classList.toggle('selected', i === index);
        });
        markerElements.forEach(function(m, i) {
          m.classList.toggle('selected', i === index);
          m.classList.remove('hover');
        });
        overlays.forEach(function(o, i) {
          o.setZIndex(i === index ? 100 : 0);
        });
        resultsList.querySelectorAll('.result-card').forEach(function(c) {
          c.classList.remove('highlight');
        });
      }

      function deselectPlace() {
        selectedPlaceIndex = -1;
        resultsList.querySelectorAll('.result-card').forEach(function(c) {
          c.classList.remove('selected');
        });
        markerElements.forEach(function(m) {
          m.classList.remove('selected', 'hover');
        });
        overlays.forEach(function(o) {
          o.setZIndex(0);
        });
      }

      function fitBounds() {
        if (overlays.length === 0) return;
        var bounds = new kakao.maps.LatLngBounds();
        overlays.forEach(function(o) { bounds.extend(o.getPosition()); });
        map.setBounds(bounds);
      }

      function panTo(lat, lng) {
        var place = new kakao.maps.LatLng(lat, lng);
        if (isMobile() && resultsPanel && mapContainer) {
          var sheetHeight = parseFloat(window.getComputedStyle(resultsPanel).height, 10);
          if (!isNaN(sheetHeight) && sheetHeight > 0) {
            if (panToVisibleCenterRafId != null) {
              cancelAnimationFrame(panToVisibleCenterRafId);
              panToVisibleCenterRafId = null;
            }
            var mapWidth = mapContainer.clientWidth || 0;
            var mapHeight = mapContainer.clientHeight || 0;
            map.setCenter(place);
            panToVisibleCenterRafId = requestAnimationFrame(function() {
              panToVisibleCenterRafId = null;
              var proj = map.getProjection();
              if (!proj) return;
              var targetCenterPixelY = mapHeight / 2 + sheetHeight / 2;
              var pt = new kakao.maps.Point(mapWidth / 2, targetCenterPixelY);
              var newCenter = null;
              if (typeof proj.coordsFromContainerPoint === 'function') {
                newCenter = proj.coordsFromContainerPoint(pt);
              } else if (typeof proj.coordsFromPoint === 'function') {
                newCenter = proj.coordsFromPoint(pt);
              }
              if (newCenter && typeof newCenter.getLat === 'function' && typeof newCenter.getLng === 'function') {
                map.setCenter(newCenter);
              }
            });
          } else {
            map.panTo(place);
          }
        } else {
          map.panTo(place);
        }
      }

      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function formatDistance(m) {
        if (m == null || isNaN(m)) return '-';
        var num = Number(m);
        if (num >= 1000) return (num / 1000).toFixed(2) + 'km';
        return Math.round(num) + 'm';
      }

      function renderResults(list) {
        showPlaceResultsView();
        deselectPlace();
        resultsPlaceholder.style.display = 'none';
        resultsList.style.display = 'flex';
        resultsList.innerHTML = '';
        list.forEach(function(place, i) {
          var y = parseFloat(place.y);
          var x = parseFloat(place.x);
          var card = document.createElement('div');
          card.className = 'result-card';
          card.setAttribute('data-index', i);
          card.innerHTML =
            '<div class="name">' + escapeHtml(place.place_name || '') + '</div>' +
            '<div class="addr">' + escapeHtml(place.address_name || '') + '</div>' +
            '<div class="card-actions">' +
            '<button type="button" class="btn-depart">출발</button>' +
            '<button type="button" class="btn-arrive">도착</button>' +
            '</div>';
          card.addEventListener('click', function(e) {
            if (e.target.closest('.card-actions')) return;
            closeBubble();
            selectPlace(i);
            panTo(y, x);
          });
          card.addEventListener('mouseenter', function() { onListCardHover(i, true); });
          card.addEventListener('mouseleave', function() { onListCardHover(i, false); });
          card.querySelector('.btn-depart').addEventListener('click', function(e) {
            e.stopPropagation();
            runDepart(i);
          });
          card.querySelector('.btn-arrive').addEventListener('click', function(e) {
            e.stopPropagation();
            runArrive(i);
          });
          resultsList.appendChild(card);
        });
      }

      function showShuttleResult(html) {
        hideShuttleErrorOverlay();
        shuttleMessage.innerHTML = html;
        shuttleMessage.classList.remove('dimmed');
        shuttleMessage.classList.add('show');
      }

      function showShuttleError(message) {
        var errorEl = document.getElementById('shuttleErrorOverlay');
        if (!errorEl) return;
        if (shuttleErrorHideTimer) {
          clearTimeout(shuttleErrorHideTimer);
          shuttleErrorHideTimer = null;
        }
        errorEl.innerHTML = escapeHtml(message || '해당 노선이 없습니다.').replace(/\n/g, '<br>');
        errorEl.classList.add('show');
        var duration = message && message.indexOf('\n') >= 0 ? 5000 : 3000;
        shuttleErrorHideTimer = setTimeout(function() {
          errorEl.classList.remove('show');
          shuttleErrorHideTimer = null;
        }, duration);
      }

      function hideShuttleErrorOverlay() {
        if (shuttleErrorHideTimer) {
          clearTimeout(shuttleErrorHideTimer);
          shuttleErrorHideTimer = null;
        }
        var errorEl = document.getElementById('shuttleErrorOverlay');
        if (errorEl) errorEl.classList.remove('show');
      }

      function drawOptionOnMap(option, placeName, isDepart) {
        clearSearchOverlays();
        clearShuttleOverlays();
        var positions = option.positions;
        var path = positions.map(function(p) { return new kakao.maps.LatLng(p.lat, p.lng); });
        var timeStr = (option.board_time != null && option.board_time !== '') ? option.board_time : getDepartureTimeStr();
        var labels = isDepart
          ? [placeName, option.nearest_stop_name, option.terminus_name]
          : [option.start_stop_name, option.getoff_stop_name, placeName];
        // z-index 우선순위 (값이 클수록 앞에 표시)
        // 출근: 탑승(i=1) > 출발지(i=0) > 하차(i=2)
        // 퇴근: 하차(i=1) > 탑승(i=0) > 목적지(i=2)
        var zOrder = isDepart ? [2, 3, 1] : [2, 3, 1];
        positions.forEach(function(p, i) {
          var pos = new kakao.maps.LatLng(p.lat, p.lng);
          var pinEl = document.createElement('div');
          pinEl.className = 'shuttle-point-pin';
          var pinOverlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: pinEl,
            xAnchor: 0.5,
            yAnchor: 0.5
          });
          pinOverlay.setZIndex(zOrder[i]);
          pinOverlay.setMap(map);
          shuttlePointOverlays.push(pinOverlay);
          var namePart = '<span class="shuttle-point-name">' + escapeHtml(labels[i]) + '</span>';
          var tagPart = '';
          if (isDepart && i === 1) tagPart = '<span class="time-tag">(' + timeStr + '분 노선 탑승)</span>';
          if (!isDepart && i === 0) tagPart = '<span class="time-tag">(' + timeStr + '분 노선 탑승)</span>';
          if (!isDepart && i === 1) {
            var seq = (option.getoff_stop_sequence != null && option.getoff_stop_sequence !== '')
              ? option.getoff_stop_sequence
              : null;
            if (seq == null && option.route_stops && option.route_stops.length > 0) {
              var targetName = String(option.getoff_stop_name || '').trim();
              for (var si = 0; si < option.route_stops.length; si++) {
                var rs = option.route_stops[si] || {};
                if (String(rs.stop_name || '').trim() === targetName) {
                  if (rs.sequence != null && rs.sequence !== '') seq = rs.sequence;
                  break;
                }
              }
            }
            var hasSeq = (seq != null && seq !== '');
            tagPart = '<span class="getoff-tag">(' + (hasSeq ? String(seq) + ' 번째 하차' : '하차') + ')</span>';
          }
          var labelAnchor = document.createElement('div');
          labelAnchor.className = 'shuttle-label-anchor';
          labelAnchor.innerHTML = '<div class="shuttle-point-label shuttle-point-' + i + '">' + namePart + tagPart + '</div>';
          var labelOverlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: labelAnchor,
            xAnchor: 0.5,
            yAnchor: 1.0
          });
          labelOverlay.setZIndex(zOrder[i] + 10);
          labelOverlay.setMap(map);
          shuttlePointOverlays.push(labelOverlay);
          shuttlePointContents.push(labelAnchor);
        });
        var lineColor = '#000';
        var lineOpts = {
          path: path,
          strokeWeight: 5,
          strokeColor: lineColor,
          strokeOpacity: 0.9
        };
        if (typeof kakao.maps.StrokeStyles !== 'undefined') {
          lineOpts.strokeStyle = kakao.maps.StrokeStyles.SHORTDASH;
        }
        shuttleLine = new kakao.maps.Polyline(lineOpts);
        shuttleLine.setMap(map);
        shuttlePositions = positions.slice();
        var bounds = new kakao.maps.LatLngBounds();
        path.forEach(function(p) { bounds.extend(p); });
        var sw = bounds.getSouthWest();
        var ne = bounds.getNorthEast();
        var latSpan = ne.getLat() - sw.getLat();
        var lngSpan = ne.getLng() - sw.getLng();
        var pad = 0.18;
        var padTop = 0.28;
        if (latSpan < 0.002) latSpan = 0.01;
        if (lngSpan < 0.002) lngSpan = 0.01;
        bounds.extend(new kakao.maps.LatLng(sw.getLat() - latSpan * pad, sw.getLng()));
        bounds.extend(new kakao.maps.LatLng(ne.getLat() + latSpan * padTop, ne.getLng()));
        bounds.extend(new kakao.maps.LatLng(sw.getLat(), sw.getLng() - lngSpan * pad));
        bounds.extend(new kakao.maps.LatLng(ne.getLat(), ne.getLng() + lngSpan * pad));
        map.setBounds(bounds);
        if (!isMobile()) {
          var msgHtml = isDepart
            ? escapeHtml(placeName) + '에서 출근하기 위해서는 <span class="time-tag">' + timeStr + '분</span>에 <span class="hl">' + escapeHtml(option.nearest_stop_name) + '</span> 정류장에서 <span class="hl">' + escapeHtml(option.route_name) + '</span> 출근 버스(노선)를 탑승하세요.'
            : escapeHtml(placeName) + '(으)로 가기 위해서는 <span class="hl">' + escapeHtml(option.route_name) + '</span> 퇴근 버스를 <span class="time-tag">' + timeStr + '분</span>에 <span class="hl">' + escapeHtml(option.start_stop_name) + '</span>에서 탑승하고 <span class="hl">' + escapeHtml(option.getoff_stop_name) + '</span>에서 하차하세요.';
          showShuttleResult(msgHtml);
        } else {
          shuttleMessage.classList.remove('show');
        }
      }

      function drawRouteDetailOnMap(option, placeName, isDepart) {
        clearSearchOverlays();
        clearShuttleOverlays();
        var routeStops = option.route_stops || [];
        if (routeStops.length === 0) return;
        var totalStops = routeStops.length;
        var path = routeStops.map(function(s) { return new kakao.maps.LatLng(s.lat, s.lng); });
        routeStops.forEach(function(s, i) {
          var pos = new kakao.maps.LatLng(s.lat, s.lng);
          var pinEl = document.createElement('div');
          pinEl.className = 'shuttle-point-pin';
          var pinZIndex = totalStops - i;
          var pinOverlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: pinEl,
            xAnchor: 0.5,
            yAnchor: 0.5
          });
          pinOverlay.setZIndex(pinZIndex);
          pinOverlay.setMap(map);
          shuttlePointOverlays.push(pinOverlay);
          var labelAnchor = document.createElement('div');
          labelAnchor.className = 'shuttle-label-anchor';
          labelAnchor.innerHTML = '<div class="shuttle-point-label shuttle-point-' + i + '">' +
            '<span class="shuttle-point-name">' + escapeHtml(s.sequence + '. ' + s.stop_name) + '</span></div>';
          var labelZIndex = totalStops - i + totalStops;
          var labelOverlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: labelAnchor,
            xAnchor: 0.5,
            yAnchor: 1.0
          });
          labelOverlay.setZIndex(labelZIndex);
          labelOverlay.setMap(map);
          shuttlePointOverlays.push(labelOverlay);
          shuttlePointContents.push(labelAnchor);
        });
        shuttlePositions = routeStops.map(function(s) { return { lat: s.lat, lng: s.lng }; });
        var lineOpts = {
          path: path,
          strokeWeight: 5,
          strokeColor: '#000',
          strokeOpacity: 0.9
        };
        if (typeof kakao.maps.StrokeStyles !== 'undefined') {
          lineOpts.strokeStyle = kakao.maps.StrokeStyles.SHORTDASH;
        }
        shuttleLine = new kakao.maps.Polyline(lineOpts);
        shuttleLine.setMap(map);
        var bounds = new kakao.maps.LatLngBounds();
        path.forEach(function(p) { bounds.extend(p); });
        var sw = bounds.getSouthWest();
        var ne = bounds.getNorthEast();
        var latSpan = ne.getLat() - sw.getLat();
        var lngSpan = ne.getLng() - sw.getLng();
        var pad = 0.12;
        if (latSpan < 0.002) latSpan = 0.01;
        if (lngSpan < 0.002) lngSpan = 0.01;
        bounds.extend(new kakao.maps.LatLng(sw.getLat() - latSpan * pad, sw.getLng()));
        bounds.extend(new kakao.maps.LatLng(ne.getLat() + latSpan * pad, ne.getLng()));
        bounds.extend(new kakao.maps.LatLng(sw.getLat(), sw.getLng() - lngSpan * pad));
        bounds.extend(new kakao.maps.LatLng(ne.getLat(), ne.getLng() + lngSpan * pad));
        map.setBounds(bounds);
        shuttleMessage.classList.remove('show');
      }

      function adjustShuttleLabels() {
        /* Labels stay fixed above their pins; overlapping is allowed */
        if (!shuttlePointContents || shuttlePointContents.length === 0) return;
        shuttlePointContents.forEach(function(anchor) {
          var el = anchor.querySelector('.shuttle-point-label');
          if (el) el.style.transform = '';
        });
      }

      function resetShuttleLabelTransforms() {
        if (!shuttlePointContents || shuttlePointContents.length === 0) return;
        shuttlePointContents.forEach(function(anchor) {
          var el = anchor.querySelector('.shuttle-point-label');
          if (el) el.style.transform = '';
        });
      }

      var currentRouteOptions = null;
      var currentPlaceName = null;
      var currentIsDepart = null;
      var expandedOptionIndex = -1;

      function formatMaxDistanceKm(value) {
        var rounded = Math.round(value);
        if (Math.abs(value - rounded) < 0.001) return String(rounded);
        return value.toFixed(1);
      }

      function updateMaxDistanceUi() {
        var appliedDisplay = formatMaxDistanceKm(maxDistanceKm);
        var pendingDisplay = formatMaxDistanceKm(maxDistancePendingKm);
        if (maxDistanceTrigger) maxDistanceTrigger.textContent = '최대 ' + appliedDisplay + ' km 이내';
        if (maxDistanceValue) maxDistanceValue.textContent = pendingDisplay;
      }

      function openMaxDistancePopover() {
        if (!maxDistancePopover || !maxDistanceTrigger) return;
        maxDistancePendingKm = maxDistanceKm;
        if (maxDistanceSlider) maxDistanceSlider.value = String(maxDistancePendingKm);
        updateMaxDistanceUi();
        maxDistancePopover.classList.add('show');
        maxDistancePopover.setAttribute('aria-hidden', 'false');
        maxDistanceTrigger.classList.add('active');
        maxDistanceTrigger.setAttribute('aria-expanded', 'true');
      }

      function closeMaxDistancePopover() {
        if (!maxDistancePopover || !maxDistanceTrigger) return;
        maxDistancePopover.classList.remove('show');
        maxDistancePopover.setAttribute('aria-hidden', 'true');
        maxDistanceTrigger.classList.remove('active');
        maxDistanceTrigger.setAttribute('aria-expanded', 'false');
      }

      function toggleMaxDistancePopover() {
        if (!maxDistancePopover) return;
        if (maxDistancePopover.classList.contains('show')) closeMaxDistancePopover();
        else openMaxDistancePopover();
      }

      function isMaxDistanceControlTarget(target) {
        if (!target || typeof target.closest !== 'function') return false;
        return !!(
          target.closest('#maxDistancePopover') ||
          target.closest('#maxDistanceTrigger')
        );
      }

      function applyMaxDistanceFilter() {
        var changed = Math.abs(maxDistanceKm - maxDistancePendingKm) > 0.001;
        maxDistanceKm = maxDistancePendingKm;
        updateMaxDistanceUi();
        closeMaxDistancePopover();
        if (changed && routeOptionsWrap && routeOptionsWrap.classList.contains('show') && lastPlace && lastShuttleType) {
          refreshLastShuttleResult({ preserveSheetState: isMobile() });
        }
      }

      function buildRouteOptionsUrl(endpoint, lat, lng, placeName, excludeRouteIds) {
        var url = API_BASE + endpoint +
          '?site_id=' + selectedSiteId +
          '&lat=' + lat + '&lng=' + lng +
          '&place_name=' + encodeURIComponent(placeName) +
          '&time=' + encodeURIComponent(getDepartureTimeStr()) +
          '&day_type=' + encodeURIComponent(selectedDayType) +
          '&max_distance_km=' + encodeURIComponent(String(maxDistanceKm)) +
          '&use_endpoint_filter=1';

        var selectedNames = getSelectedEndpointNamesSorted();
        if (selectedNames.length === 0) {
          url += '&selected_endpoints=';
        } else if (!isAllEndpointsSelected()) {
          url += '&selected_endpoints=' + encodeURIComponent(selectedNames.join(','));
        }

        if (excludeRouteIds) {
          url += '&exclude_route_ids=' + encodeURIComponent(excludeRouteIds);
        }
        return url;
      }

      function sortOptions(options, mode) {
        var sorted = options.slice();
        if (mode === 'time') {
          sorted.sort(function(a, b) {
            var ta = a.board_time || '';
            var tb = b.board_time || '';
            return ta.localeCompare(tb);
          });
        } else {
          sorted.sort(function(a, b) {
            return (a.distance_m || 0) - (b.distance_m || 0);
          });
        }
        return sorted;
      }

      function updateSortButtons() {
        document.getElementById('sortByDistance').classList.toggle('active', currentSortMode === 'distance');
        document.getElementById('sortByTime').classList.toggle('active', currentSortMode === 'time');
      }

      function renderRouteCards(options, placeName, isDepart) {
        routeOptionsWrap.innerHTML = '';
        expandedOptionIndex = -1;
        // "더 가져오기" 버튼 제거 (재렌더 시)
        var existingBtn = routeOptionsWrap.querySelector('.btn-load-more-routes');
        if (existingBtn) existingBtn.remove();
        options.forEach(function(opt, idx) {
          var card = document.createElement('div');
          card.className = 'route-option-card' + (idx === 0 ? ' selected' : '');
          var timeStr = (opt.board_time != null && opt.board_time !== '') ? opt.board_time : getDepartureTimeStr();
          var pathDetail = isDepart
            ? escapeHtml(placeName) + ' → ' + escapeHtml(opt.nearest_stop_name) + ' → ' + escapeHtml(opt.terminus_name)
            : escapeHtml(opt.start_stop_name) + ' → ' + escapeHtml(opt.getoff_stop_name) + ' 하차 → ' + escapeHtml(placeName);
          var distStr = formatDistance(opt.distance_m);
          var metaLine = distStr + ' · ' + timeStr + '분 노선';
          var allTimes = opt.all_departure_times || [];
          var timesHtml = allTimes.map(function(t) {
            var isCurrent = (t === timeStr);
            return '<span class="time-item' + (isCurrent ? ' current' : '') + '">' + escapeHtml(t) + '</span>';
          }).join('');
          // 탑승/하차 정류장 이름 결정
          var boardStopName = isDepart ? (opt.nearest_stop_name || '') : (opt.start_stop_name || '');
          var alightStopName = isDepart ? (opt.terminus_name || '') : (opt.getoff_stop_name || '');
          // 노선 전체 정류장 목록 HTML
          var routeStops = opt.route_stops || [];
          var stopsHtml = routeStops.map(function(s) {
            var name = s.stop_name || '';
            var isBoardStop = (name === boardStopName);
            var isAlightStop = (name === alightStopName);
            var label = isBoardStop ? ' (탑승)' : (isAlightStop ? ' (하차)' : '');
            var bold = (isBoardStop || isAlightStop);
            return '<div class="route-stop-item' + (bold ? ' highlight' : '') + '">' +
              (bold ? '<b>' : '') +
              escapeHtml(s.sequence + '. ' + name) + label +
              (bold ? '</b>' : '') +
            '</div>';
          }).join('');
          card.innerHTML =
            '<div class="card-main">' +
              '<div class="card-title-wrap">' +
                '<div class="route-name">' + escapeHtml(opt.route_name) + '</div>' +
                '<div class="route-meta">' + escapeHtml(metaLine) + '</div>' +
              '</div>' +
              '<button type="button" class="btn-route-detail" data-idx="' + idx + '">노선 상세</button>' +
            '</div>' +
            '<div class="route-detail">' + pathDetail + '</div>' +
            '<div class="route-detail-panel">' +
              '<div class="detail-title">출발 시간</div>' +
              '<div class="departure-times">' + (timesHtml || '-') + '</div>' +
              (opt.notes ? '<div class="route-extra-info">' + escapeHtml(opt.notes) + '</div>' : '') +
              (opt.operator ? '<div class="route-extra-info">' + escapeHtml(opt.operator) + '</div>' : '') +
              '<hr class="route-stops-divider">' +
              '<div class="detail-title">노선 경유지</div>' +
              '<div class="route-stops-list">' + (stopsHtml || '-') + '</div>' +
              (dbUpdatedAt ? '<div class="route-db-updated">마지막 업데이트: ' + escapeHtml(dbUpdatedAt) + '</div>' : '') +
            '</div>';
          var btnDetail = card.querySelector('.btn-route-detail');
          card.addEventListener('click', function(e) {
            if (e.target.closest('.btn-route-detail')) return;
            routeOptionsWrap.querySelectorAll('.route-option-card').forEach(function(c) { c.classList.remove('selected'); });
            card.classList.add('selected');
            if (expandedOptionIndex >= 0) {
              expandedOptionIndex = -1;
              routeOptionsWrap.querySelectorAll('.route-option-card').forEach(function(c) { c.classList.remove('expanded'); });
            }
            drawOptionOnMap(opt, placeName, isDepart);
          });
          btnDetail.addEventListener('click', function(e) {
            e.stopPropagation();
            if (expandedOptionIndex === idx) {
              expandedOptionIndex = -1;
              card.classList.remove('expanded');
              routeOptionsWrap.querySelectorAll('.route-option-card').forEach(function(c) { c.classList.remove('selected'); });
              card.classList.add('selected');
              drawOptionOnMap(opt, placeName, isDepart);
              return;
            }
            routeOptionsWrap.querySelectorAll('.route-option-card').forEach(function(c) {
              c.classList.remove('expanded');
              if (c !== card) c.classList.remove('selected');
            });
            card.classList.add('expanded', 'selected');
            expandedOptionIndex = idx;
            drawRouteDetailOnMap(opt, placeName, isDepart);
          });
          routeOptionsWrap.appendChild(card);
        });
        // 마지막 배치가 5개(max_routes)이면 "더 가져오기" 버튼 표시
        var lastBatchSize = options._lastBatchSize != null ? options._lastBatchSize : options.length;
        if (lastBatchSize >= 5) {
          var loadMoreBtn = document.createElement('button');
          loadMoreBtn.type = 'button';
          loadMoreBtn.className = 'btn-load-more-routes';
          loadMoreBtn.textContent = '노선 더 가져오기 (최대 5개)';
          loadMoreBtn.addEventListener('click', function() { loadMoreRoutes(loadMoreBtn); });
          routeOptionsWrap.appendChild(loadMoreBtn);
        }
        drawOptionOnMap(options[0], placeName, isDepart);
      }

      function loadMoreRoutes(btn) {
        if (!currentRouteOptions || !lastPlace) return;
        if (selectedEndpoints.size === 0) {
          btn.textContent = '선택된 옵션 없음';
          btn.disabled = true;
          return;
        }
        btn.disabled = true;
        btn.textContent = '불러오는 중...';
        var lat = parseFloat(lastPlace.y);
        var lng = parseFloat(lastPlace.x);
        var name = currentPlaceName || lastPlace.place_name || '선택한 장소';
        var isDepart = currentIsDepart;
        var endpoint = isDepart ? '/api/shuttle/depart/options' : '/api/shuttle/arrive/options';
        var excludeIds = currentRouteOptions.map(function(o) { return o.route_id; }).join(',');
        var url = buildRouteOptionsUrl(endpoint, lat, lng, name, excludeIds);
        fetch(url)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var newOptions = (data.options || []);
            if (newOptions.length === 0) {
              btn.textContent = '추가 노선 없음';
              btn.disabled = true;
              return;
            }
            // 기존 옵션에 새 옵션 합산
            currentRouteOptions = currentRouteOptions.concat(newOptions);
            currentRouteOptions._lastBatchSize = newOptions.length;
            // 현재 정렬 모드에 맞춰 전체 재정렬 후 렌더
            var sorted = sortOptions(currentRouteOptions, currentSortMode);
            sorted._lastBatchSize = newOptions.length;
            renderRouteCards(sorted, currentPlaceName, currentIsDepart);
          })
          .catch(function() {
            btn.textContent = '노선 더 가져오기 (최대 5개)';
            btn.disabled = false;
          });
      }

      function renderRouteOptions(options, placeName, isDepart, lastDepartureTime, preserveSheetState, emptyMessage) {
        var shouldPreserveSheetState = !!preserveSheetState;
        setRouteMode(true, isDepart ? 'depart' : 'arrive', placeName);
        panelTitle.textContent = '노선 선택';
        var btnBack = document.getElementById('btnBackFromRoutes');
        if (btnBack) btnBack.style.display = '';
        resultsPlaceholder.style.display = 'none';
        resultsList.style.display = 'none';
        routeOptionsWrap.innerHTML = '';
        routeOptionsWrap.classList.add('show');
        currentRouteOptions = options;
        currentRouteOptions._lastBatchSize = options.length;
        currentPlaceName = placeName;
        currentIsDepart = isDepart;
        expandedOptionIndex = -1;
        routeSortBar.classList.add('show');
        updateSortButtons();
        if (options.length === 0) {
          closeMaxDistancePopover();
          clearSearchOverlays();
          clearShuttleOverlays();
          shuttleMessage.classList.remove('show');
          shuttleMessage.innerHTML = '';
          var noRouteMsg = emptyMessage || '';
          if (!noRouteMsg) {
            var dirLabel = isDepart ? '출근' : '퇴근';
            noRouteMsg = '설정한 시간에 탑승 가능한 노선이 없습니다.';
            if (lastDepartureTime) {
              noRouteMsg += '\n이 장소 근방 ' + dirLabel + ' 셔틀의 마지막 출발 시간은 ' + lastDepartureTime + ' 입니다.';
            }
          }
          var emptyMsg = document.createElement('div');
          emptyMsg.className = 'results-placeholder';
          emptyMsg.style.display = 'block';
          emptyMsg.style.whiteSpace = 'pre-line';
          emptyMsg.textContent = noRouteMsg;
          routeOptionsWrap.appendChild(emptyMsg);
          showShuttleError(noRouteMsg);
          if (isMobile() && !shouldPreserveSheetState) setSheetState('sheet-half');
          return;
        }
        var sorted = sortOptions(options, currentSortMode);
        sorted._lastBatchSize = options.length;
        renderRouteCards(sorted, placeName, isDepart);
        if (isMobile() && !shouldPreserveSheetState) setSheetState('sheet-peek');
      }

      function showPlaceResultsView() {
        routeRequestSerial += 1;
        setRouteMode(false);
        panelTitle.textContent = '검색 결과';
        var btnBack = document.getElementById('btnBackFromRoutes');
        if (btnBack) btnBack.style.display = 'none';
        routeSortBar.classList.remove('show');
        closeMaxDistancePopover();
        routeOptionsWrap.classList.remove('show');
        routeOptionsWrap.innerHTML = '';
      }

      function goBackFromRouteOptions() {
        routeRequestSerial += 1;
        closeEndpointPickerModal({ applySelection: false, refreshOnApply: false });
        lastPlace = null;
        lastShuttleType = null;
        clearShuttleOverlays();
        shuttleMessage.classList.remove('show');
        deselectPlace();
        if (places.length > 0) {
          places.forEach(function(p, i) {
            var lat = parseFloat(p.y);
            var lng = parseFloat(p.x);
            addMarker(lat, lng, i);
          });
          fitBounds();
        }
        showPlaceResultsView();
        if (places.length > 0) {
          resultsList.style.display = 'flex';
          resultsPlaceholder.style.display = 'none';
        } else {
          resultsPlaceholder.style.display = 'block';
          resultsPlaceholder.textContent = '검색어를 입력한 뒤 검색하면 여기에 표시됩니다.';
          resultsList.style.display = 'none';
        }
      }

      function runDepart(placeIndex) {
        var place = places[placeIndex];
        if (!place) return;
        runDepartWithPlace(place);
      }

      function runDepartWithPlace(place, opts) {
        runRouteSearchWithPlace(place, 'depart', opts);
      }

      function runArrive(placeIndex) {
        var place = places[placeIndex];
        if (!place) return;
        runArriveWithPlace(place);
      }

      function runArriveWithPlace(place, opts) {
        runRouteSearchWithPlace(place, 'arrive', opts);
      }

      function runRouteSearchWithPlace(place, direction, opts) {
        opts = opts || {};
        lastPlace = place;
        lastShuttleType = direction;
        var lat = parseFloat(place.y);
        var lng = parseFloat(place.x);
        var name = place.place_name || '선택한 위치';
        var isDepart = direction === 'depart';
        var emptyBySelectionMsg = isDepart
          ? '선택한 출근 종착지 옵션이 없습니다.'
          : '선택한 퇴근 출발지 옵션이 없습니다.';
        setRouteMode(true, direction, name);
        var requestId = ++routeRequestSerial;

        loadEndpointOptions(direction)
          .then(function() {
            if (requestId !== routeRequestSerial) return null;
            if (selectedEndpoints.size === 0) {
              renderRouteOptions([], name, isDepart, '', opts.preserveSheetState, emptyBySelectionMsg);
              return null;
            }
            var endpoint = isDepart ? '/api/shuttle/depart/options' : '/api/shuttle/arrive/options';
            var url = buildRouteOptionsUrl(endpoint, lat, lng, name, '');
            return fetch(url)
              .then(function(r) {
                return r.json().catch(function() { return {}; }).then(function(data) {
                  return { ok: r.ok, data: data };
                });
              })
              .then(function(result) {
                if (requestId !== routeRequestSerial) return;
                var data = result.data || {};
                if (!result.ok && data.options == null) {
                  showShuttleError(data.error || (isDepart ? '출근 노선 조회에 실패했습니다.' : '퇴근 노선 조회에 실패했습니다.'));
                  return;
                }
                if (data.error) {
                  showShuttleError(data.error);
                  return;
                }
                var options = data.options || [];
                renderRouteOptions(options, name, isDepart, data.last_departure_time || '', opts.preserveSheetState);
              });
          })
          .catch(function(err) {
            if (requestId !== routeRequestSerial) return;
            showShuttleError(err && err.message ? err.message : '노선 조회에 실패했습니다.');
          });
      }

      function showEmptyResults() {
        resultsPlaceholder.style.display = 'block';
        resultsPlaceholder.textContent = '검색 결과가 없습니다.';
        resultsList.style.display = 'none';
        resultsList.innerHTML = '';
      }

      function doSearch() {
        var q = searchInput.value.trim();
        if (!q) return;
        shuttleMessage.classList.remove('show');
        clearShuttleOverlays();
        fetch(API_BASE + '/api/search?q=' + encodeURIComponent(q))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            places = data.documents || [];
            clearSearchOverlays();
            if (places.length === 0) {
              showPlaceResultsView();
              showEmptyResults();
              return;
            }
            places.forEach(function(p, i) {
              var lat = parseFloat(p.y);
              var lng = parseFloat(p.x);
              addMarker(lat, lng, i);
            });
            fitBounds();
            renderResults(places);
            if (isMobile()) setSheetState('sheet-half');
          })
          .catch(function() {
            showPlaceResultsView();
            showEmptyResults();
          });
      }

      var locationPermissionOnConfirm = null;
      function openLocationPermissionModal(message, onConfirm) {
        if (!locationPermissionMessage || !locationPermissionBackdrop || !locationPermissionModal) return;
        locationPermissionMessage.textContent = message;
        locationPermissionOnConfirm = onConfirm || null;
        locationPermissionBackdrop.classList.add('show');
        locationPermissionModal.classList.add('show');
      }
      function closeLocationPermissionModal() {
        locationPermissionOnConfirm = null;
        if (locationPermissionBackdrop) locationPermissionBackdrop.classList.remove('show');
        if (locationPermissionModal) locationPermissionModal.classList.remove('show');
      }
      function requestLocationThenMove() {
        var opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
        navigator.geolocation.getCurrentPosition(
          function(pos) {
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            if (currentLocationOverlay) {
              currentLocationOverlay.setMap(null);
              currentLocationOverlay = null;
            }
            var el = document.createElement('div');
            el.className = 'current-location-marker';
            currentLocationOverlay = new kakao.maps.CustomOverlay({
              position: new kakao.maps.LatLng(lat, lng),
              content: el,
              yAnchor: 0.5,
              xAnchor: 0.5
            });
            currentLocationOverlay.setMap(map);
            map.setCenter(new kakao.maps.LatLng(lat, lng));
            map.setLevel(3);
          },
          function(err) {
            var msg;
            if (err.code === 1) {
              msg = '위치 권한이 거부되었습니다. PC: 브라우저 주소창 왼쪽 자물쇠(또는 아이콘)에서 이 사이트의 위치 권한을 허용해 주세요. 모바일: 기기 설정에서 브라우저 앱 > 이 웹사이트 > 위치 권한을 허용해 주세요.';
              openLocationPermissionModal(msg);
            } else if (err.code === 2) {
              msg = '위치 정보를 사용할 수 없습니다. 네트워크나 GPS를 확인해 주세요.';
              openLocationPermissionModal(msg);
            } else if (err.code === 3) {
              msg = '시간이 초과되었습니다. 잠시 후 다시 시도해 주세요.';
              openLocationPermissionModal(msg);
            } else {
              openLocationPermissionModal('위치를 가져올 수 없습니다. 위치 권한을 확인해 주세요.');
            }
          },
          opts
        );
      }
      function moveToCurrentLocation() {
        if (!navigator.geolocation) {
          alert('이 브라우저는 위치 기능을 지원하지 않습니다.');
          return;
        }
        // 이미 권한이 부여됐으면 모달 없이 바로 위치 요청
        if (navigator.permissions && navigator.permissions.query) {
          navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
            if (result.state === 'granted') {
              requestLocationThenMove();
            } else {
              openLocationPermissionModal(
                '현재 위치를 표시하려면 위치 권한이 필요합니다. 확인을 누르면 브라우저에서 권한 요청이 표시됩니다.',
                function() {
                  closeLocationPermissionModal();
                  requestLocationThenMove();
                }
              );
            }
          }).catch(function() {
            // permissions API 미지원 시 바로 위치 요청
            requestLocationThenMove();
          });
        } else {
          // permissions API 미지원 시 바로 위치 요청
          requestLocationThenMove();
        }
      }

      function zoomIn() {
        if (!map) return;
        var level = map.getLevel();
        map.setLevel(Math.max(1, level - 1), { animate: true });
      }
      function zoomOut() {
        if (!map) return;
        var level = map.getLevel();
        map.setLevel(Math.min(14, level + 1), { animate: true });
      }

      searchBtn.addEventListener('click', doSearch);
      searchInput.addEventListener('keydown', function(e) {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        if (e.isComposing) {
          searchInput.addEventListener('compositionend', function onCompEnd() {
            searchInput.removeEventListener('compositionend', onCompEnd);
            searchInput.blur();
            doSearch();
          }, { once: true });
        } else {
          searchInput.blur();
          doSearch();
        }
      });
      document.getElementById('btnZoomIn').addEventListener('click', zoomIn);
      document.getElementById('btnZoomOut').addEventListener('click', zoomOut);
      btnLocation.addEventListener('click', moveToCurrentLocation);
      if (locationPermissionConfirm) {
        locationPermissionConfirm.addEventListener('click', function() {
          if (locationPermissionOnConfirm) locationPermissionOnConfirm();
          closeLocationPermissionModal();
        });
      }
      if (locationPermissionBackdrop) {
        locationPermissionBackdrop.addEventListener('click', closeLocationPermissionModal);
      }
      var btnBackFromRoutes = document.getElementById('btnBackFromRoutes');
      if (btnBackFromRoutes) btnBackFromRoutes.addEventListener('click', goBackFromRouteOptions);

      document.getElementById('sortByDistance').addEventListener('click', function() {
        if (currentSortMode === 'distance') return;
        currentSortMode = 'distance';
        updateSortButtons();
        if (currentRouteOptions && currentRouteOptions.length > 0) {
          var sorted = sortOptions(currentRouteOptions, currentSortMode);
          sorted._lastBatchSize = currentRouteOptions._lastBatchSize;
          renderRouteCards(sorted, currentPlaceName, currentIsDepart);
        }
      });
      document.getElementById('sortByTime').addEventListener('click', function() {
        if (currentSortMode === 'time') return;
        currentSortMode = 'time';
        updateSortButtons();
        if (currentRouteOptions && currentRouteOptions.length > 0) {
          var sorted = sortOptions(currentRouteOptions, currentSortMode);
          sorted._lastBatchSize = currentRouteOptions._lastBatchSize;
          renderRouteCards(sorted, currentPlaceName, currentIsDepart);
        }
      });
      if (maxDistanceTrigger) {
        maxDistanceTrigger.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleMaxDistancePopover();
        });
      }
      if (maxDistancePopover) {
        maxDistancePopover.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      if (maxDistanceSlider) {
        maxDistanceSlider.addEventListener('input', function() {
          var next = parseFloat(maxDistanceSlider.value);
          if (!isFinite(next)) return;
          maxDistancePendingKm = next;
          updateMaxDistanceUi();
        });
      }
      if (maxDistanceConfirm) {
        maxDistanceConfirm.addEventListener('click', function() {
          applyMaxDistanceFilter();
        });
      }
      document.addEventListener('click', function(e) {
        if (!maxDistancePopover || !maxDistancePopover.classList.contains('show')) return;
        if (maxDistancePopover.contains(e.target)) return;
        if (maxDistanceTrigger && maxDistanceTrigger.contains(e.target)) return;
        closeMaxDistancePopover();
      });
      document.addEventListener('click', function(e) {
        if (!endpointPickerModal || !endpointPickerModal.classList.contains('show')) return;
        if (endpointPickerModal.contains(e.target)) return;
        var activeEndpointTrigger = getActiveEndpointTriggerElement();
        if (activeEndpointTrigger && activeEndpointTrigger.contains(e.target)) return;
        closeEndpointPickerModal();
      });
      updateMaxDistanceUi();

      (function initDepartureClock() {
        setDepartureFromDate(new Date());
        updateDepartureTriggerText();
        if (departureTrigger) {
          departureTrigger.addEventListener('click', function(e) {
            e.preventDefault();
            openTimePickerModal();
          });
        }
        if (timePickerConfirm) timePickerConfirm.addEventListener('click', applyTimePicker);
        if (timePickerFive) timePickerFive.addEventListener('click', setTimePickerToFive);
        if (timePickerNow) timePickerNow.addEventListener('click', setTimePickerToNow);
        if (timePickerBackdrop) timePickerBackdrop.addEventListener('click', closeTimePickerModal);
        if (timePickerModal) timePickerModal.addEventListener('click', function(e) { e.stopPropagation(); });
        if (dayTypeList) dayTypeList.addEventListener('scroll', updateDayTypeSelectedClasses);
        if (timePickerHourList) timePickerHourList.addEventListener('scroll', updateTimePickerSelectedClasses);
        if (timePickerMinuteList) timePickerMinuteList.addEventListener('scroll', updateTimePickerSelectedClasses);
        // 리사이즈 시 trigger 텍스트 재측정
        window.addEventListener('resize', function() { fitDepartureTrigger(); });
      })();

      (function initBottomSheet() {
        var sheetDragArea = document.getElementById('sheetDragArea');
        if (!sheetDragArea || !resultsPanel) return;
        var PEEK_H = 72;
        var states = ['sheet-peek', 'sheet-half', 'sheet-full'];
        function getHeights() {
          var vh = window.innerHeight;
          return { peek: PEEK_H, half: Math.round(vh * 0.5), full: Math.round(vh * 0.85) };
        }
        function getCurrentState() {
          for (var i = 0; i < states.length; i++) {
            if (resultsPanel.classList.contains(states[i])) return i;
          }
          return 1;
        }
        function setStateIndex(i) {
          resultsPanel.classList.remove('sheet-dragging');
          resultsPanel.style.height = '';
          setSheetState(states[i]);
          if (i === 0) {
            deselectPlace();
            setMapDimmed(false);
            closeBubble();
          }
        }
        function getPanelHeightPx() {
          var h = parseFloat(window.getComputedStyle(resultsPanel).height, 10);
          return isNaN(h) ? window.innerHeight * 0.5 : h;
        }
        var DRAG_THRESHOLD = 25;
        var startY = 0, startHeightPx = 0, dragStartStateIndex = 1, dragging = false;

        function beginSheetDrag(initialY) {
          dragStartStateIndex = getCurrentState();
          startHeightPx = getPanelHeightPx();
          resultsPanel.classList.add('sheet-dragging');
          resultsPanel.classList.remove('sheet-peek', 'sheet-half', 'sheet-full');
          resultsPanel.style.height = startHeightPx + 'px';
          startY = initialY;
          dragging = true;
        }
        function onMove(clientY) {
          if (!dragging) return;
          var heights = getHeights();
          var maxH = heights.full;
          var newH = startHeightPx + (startY - clientY);
          newH = Math.max(heights.peek, Math.min(maxH, newH));
          resultsPanel.style.height = newH + 'px';
          updateMapControlsPosition();
        }
        function onEnd(clientY) {
          if (!dragging) return;
          dragging = false;
          var deltaY = startY - clientY;
          var nextIndex = dragStartStateIndex;
          if (deltaY > DRAG_THRESHOLD) {
            nextIndex = Math.min(2, dragStartStateIndex + 1);
          } else if (deltaY < -DRAG_THRESHOLD) {
            nextIndex = Math.max(0, dragStartStateIndex - 1);
          }
          resultsPanel.classList.remove('sheet-dragging');
          setStateIndex(nextIndex);
        }

        sheetDragArea.addEventListener('touchstart', function(e) {
          if (!e.touches.length) return;
          beginSheetDrag(e.touches[0].clientY);
        }, { passive: true });
        sheetDragArea.addEventListener('touchmove', function(e) {
          if (e.touches.length && dragging) onMove(e.touches[0].clientY);
        }, { passive: true });
        sheetDragArea.addEventListener('touchend', function(e) {
          if (!e.changedTouches.length) return;
          onEnd(e.changedTouches[0].clientY);
        }, { passive: true });

        var sheetDragActive = false;
        sheetDragArea.addEventListener('mousedown', function(e) {
          beginSheetDrag(e.clientY);
          sheetDragActive = true;
        });
        document.addEventListener('mousemove', function(e) {
          if (sheetDragActive && dragging) onMove(e.clientY);
        });
        document.addEventListener('mouseup', function(e) {
          if (!sheetDragActive) return;
          if (dragging) onEnd(e.clientY);
          sheetDragActive = false;
        });

        var listWrap = resultsPanel.querySelector('.results-list-wrap');
        if (listWrap) {
          var listTouchStartY = 0, listTouchStartScroll = 0, listGestureMode = null;
          var MOVE_THRESHOLD = 10;
          listWrap.addEventListener('touchstart', function(e) {
            if (!e.touches.length) return;
            if (isMaxDistanceControlTarget(e.target)) {
              listGestureMode = 'control';
              return;
            }
            listTouchStartY = e.touches[0].clientY;
            listTouchStartScroll = listWrap.scrollTop;
            listGestureMode = null;
          }, { passive: true });
          listWrap.addEventListener('touchmove', function(e) {
            if (!e.touches.length) return;
            if (listGestureMode === 'control' || isMaxDistanceControlTarget(e.target)) return;
            var currentY = e.touches[0].clientY;
            var deltaY = listTouchStartY - currentY;
            if (listGestureMode === null) {
              if (deltaY > MOVE_THRESHOLD) {
                if (getCurrentState() < 2) {
                  listGestureMode = 'sheet';
                  beginSheetDrag(listTouchStartY);
                } else {
                  listGestureMode = 'list';
                }
              } else if (deltaY < -MOVE_THRESHOLD) {
                if (listTouchStartScroll > 0) {
                  listGestureMode = 'list';
                } else {
                  listGestureMode = 'sheet';
                  beginSheetDrag(listTouchStartY);
                }
              }
            }
            if (listGestureMode === 'sheet') {
              e.preventDefault();
              onMove(currentY);
            }
          }, { passive: false });
          listWrap.addEventListener('touchend', function(e) {
            if (listGestureMode === 'sheet' && e.changedTouches.length) {
              onEnd(e.changedTouches[0].clientY);
            }
            listGestureMode = null;
          }, { passive: true });
          listWrap.addEventListener('touchcancel', function() {
            listGestureMode = null;
          }, { passive: true });
        }
      })();

      if (typeof kakao !== 'undefined' && kakao.maps) {
        initMap();
        loadSites();
        updateMapControlsPosition();
        if (isMobile()) {
          setSheetState('sheet-peek');
        }
      } else {
        mapContainer.innerHTML = '<p style="padding:20px">지도 API 키를 설정해주세요. (KAKAO_JAVASCRIPT_KEY)</p>';
      }
      window.addEventListener('resize', updateMapControlsPosition);
    };
  </script>
</body>
</html>
